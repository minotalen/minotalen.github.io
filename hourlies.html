<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hourlies</title>
    <link href="https://fonts.googleapis.com/css2?family=Atkinson+Hyperlegible:wght@400;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            user-select: none;
        }
        
        body {
            font-family: 'Atkinson Hyperlegible', sans-serif;
            background-color: #111827;
            color: white;
            height: 100vh;
            overflow: hidden;
        }
        
        /* LAYOUT */
        .header {
            background-color: #1f2937;
            padding: 0 12%;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .main-container {
            height: calc(100vh - 72px);
            position: relative;
        }
        
        .scroll-container, .settings-container, .daily-container {
            padding: 16px 12%;
            height: 100%;
            overflow-y: auto;
        }
        
        /* BUTTONS & INPUTS */
        .btn {
            background: none;
            border: none;
            color: #aeb6c3;
            cursor: pointer;
            transition: color 0.2s;
            font-size: clamp(1.1rem, 4vw, 1.3rem);
        }
        
        .btn:hover, .btn-active {
            color: white;
        }
        
        .btn-active {
            font-weight: 700;
        }
        
        input, select, textarea {
            background: none;
            border: none;
            color: #aeb6c3;
            font-family: inherit;
            transition: color 0.2s;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            color: white;
        }
        
        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        
        input[type=number] {
            -webkit-appearance: textfield;
        }
        
        textarea {
            color: #d1d5db;
            font-size: 20px;
        }       
        /* HEADER */
        .header h1 {
            font-size: clamp(1.2rem, 4vw, 1.8rem);
            font-weight: 700;
            cursor: pointer;
            transition: color 0.2s;
            color: #aeb6c3;
        }
        
        .header h1:hover {
            color: white;
        }
        
        .header-buttons {
            display: flex;
            gap: 1rem;
            align-items: center;
        }
        
        .btn-label {
            font-size: clamp(0.7rem, 2.5vw, 0.8rem);
            vertical-align: middle;
        }
        
        /* DATE NAVIGATION */
        .date-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .date-nav-left, .date-nav-right {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .date-input {
            font-size: clamp(1.2rem, 5vw, 1.5rem);
            text-align: center;
            width: clamp(140px, 30vw, 160px);
            cursor: pointer;
        }
        .date-btn {
            background-color: transparent;
            color: #6b7280;
            cursor: pointer;
            transition: color 0.2s;
            font-size: clamp(1.2rem, 5vw, 1.5rem);
        }
        .secondary-btn {
            font-size: clamp(1.2rem, 5vw, 1.5rem);
        }
        
        .jump-btn {
            background-color: #1f2937;
            color: #6b7280;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            cursor: pointer;
            transition: color 0.2s;
            font-size: clamp(0.8rem, 3vw, 1rem);
        }
        
        .jump-btn:hover {
            color: #d1d5db;
        }
        
        /* GOALS */
        .goals-section {
            margin-bottom: 24px;
            padding: 12px;
            background-color: #1f2937;
            border-radius: 8px;
        }
        
        .goals-title {
            font-weight: 600;
            color: #60a5fa;
            margin-bottom: 8px;
        }
        
        .goal-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            margin-bottom: 4px;
            padding: 4px 8px;
            border-radius: 4px;
        }
        
        .goal-item.passed {
            background-color: #364e36;
        }
        
        .goal-item.failed {
            background-color: #5f3b3b;
        }
        
        .goal-text {
            color: #d1d5db;
            font-size: 1.4em;
            font-weight: 500;
        }
        
        .no-goals {
            padding: 8px 12px;
            border-radius: 4px;
            background-color: #2a313e;
            color: #6b7280;
            text-align: center;
            font-size: 14px;
        }
        
        /* HOURS */
        .hour-row {
            position: relative;
            margin-bottom: 8px;
        }
        
        .hour-entry {
            position: relative;
            cursor: pointer;
            padding: 12px 16px;
            border-radius: 4px;
            background-color: #343d4e;
            overflow: hidden;
            transition: all 0.2s;
        }
        
        .hour-entry:hover {
            background-color: #373e49;
        }
        
        .hour-entry.current {
            box-shadow: 0 0 0 2px #3b82f6;
        }
        
        .hour-entry.editing {
            box-shadow: 0 0 0 2px #3108ea;
            z-index: 40;
            user-select: text;
        }
        
        .hour-fill {
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            background-color: #334870;
        }
        
        .hour-fill.empty {
            background-color: #1f242d;
        }
        
        .hour-content {
            position: relative;
            display: flex;
            align-items: flex-start;
            gap: 6px;
        }
        
        .hour-time {
            font-size: 24px;
            width: 32px;
        }
        
        .hour-emojis {
            display: grid;
            grid-template-columns: repeat(2, 30px);
            gap: 4px;
            min-height: 30px;
            max-height: calc(30px * 3 + 8px);
            overflow: hidden;
            max-width: 64px;
            min-width: 64px;
            padding-right: 24px;
        }
        
        .emoji {
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 28px;
            min-height: 28px;
        }
        
        .hour-input-container {
            flex: 1;
            display: flex;
            align-items: flex-start;
            position: relative;
        }
        
        .hour-input {
            flex: 1;
            background: transparent;
            color: #d1d5db;
            resize: none;
            overflow: hidden;
            min-height: 36px;
            line-height: 1.5;
            margin-top: 4px;
            transition: height 0.15s ease-out;
            user-select: text;
        }
        
        .hour-input::placeholder {
            color: #6b7280;
        }
        
        .hour-input.empty {
            color: #6b7280;
        }
        
        .hour-input.scrolling {
            overflow-y: auto;
        }
        
        .hour-text {
            color: #d1d5db;
            font-size: 20px;
        }
        
        .clear-btn {
            position: absolute;
            right: 0;
            top: 0;
            background: none;
            border: none;
            color: #eb6f6f;
            cursor: pointer;
            font-size: 28px;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s ease;
            z-index: 2;
        }
        
        /* EMOJI PICKER */
        .emoji-picker {
            position: absolute;
            left: 0;
            right: 0;
            background-color: #1f2937;
            padding: 12px;
            display: grid;
            grid-template-columns: repeat(auto-fit, 48px);
            justify-content: center;
            gap: 8px;
            z-index: 50;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
        }
        
        .emoji-picker.above {
            bottom: 100%;
            margin-bottom: 8px;
        }
        
        .emoji-picker.below {
            top: 100%;
            margin-top: 8px;
        }
        
        .emoji-btn {
            padding: 8px;
            font-size: 32px;
            background: none;
            border: none;
            cursor: pointer;
            transition: background-color 0.2s;
            border-radius: 4px;
        }
        
        .emoji-btn:hover {
            background-color: #373e49;
        }
        
        .emoji-btn.selected {
            background-color: #456090;
        }
        
        .emoji-btn.selected:hover {
            background-color: #1d4ed8;
        }
        
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 30;
        }
        
        /* SCROLL BAR */
        .scroll-bar {
            position: absolute;
            top: 0;
            right: 0;
            bottom: 0;
            width: 48px;
            cursor: ns-resize;
            transition: all 0.2s;
            background: repeating-linear-gradient(
                45deg,
                transparent 0px,
                transparent 3px,
                rgba(255,255,255,0.08) 3px,
                rgba(255,255,255,0.08) 4px,
                transparent 4px,
                transparent 8px
            ),
            repeating-linear-gradient(
                -45deg,
                transparent 0px,
                transparent 3px,
                rgba(255,255,255,0.08) 3px,
                rgba(255,255,255,0.08) 4px,
                transparent 4px,
                transparent 8px
            );
        }
        
        .scroll-bar.hidden {
            display: none;
        }
        
        .scroll-bar.dragging {
            background-color: rgba(255, 255, 255, 0.1);
        }
        
        .hour-indicator {
            position: absolute;
            right: 8px;
            width: 0;
            height: 0;
            border-left: 6px solid #3b82f6;
            border-top: 3px solid transparent;
            border-bottom: 3px solid transparent;
            animation: pulse 2s infinite;
            pointer-events: none;
            transform: translateY(-50%);
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        /* SETTINGS */
        .setting-group {
            margin-bottom: 24px;
        }
        
        .setting-label {
            display: block;
            color: #d1d5db;
            margin-bottom: 8px;
            font-size: 18px;
        }
        
        .setting-input {
            width: 100%;
            padding: 12px;
            background-color: #2a313e;
            color: white;
            border-radius: 4px;
            font-size: 18px;
            font-family: 'Space Mono', monospace;
        }
        
        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 18px;
            cursor: pointer;
        }
        
        .checkbox {
            width: 20px;
            height: 20px;
        }
        
        .add-goal-btn, .export-btn {
            background-color: #334970;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .add-goal-btn:hover, .export-btn:hover {
            background-color: #173ca4;
        }
        
        /* GOAL EDITOR */
        .goal-row {
            position: relative;
            margin-bottom: 12px;
        }
        
        .goal-summary {
            cursor: pointer;
            padding: 12px;
            background-color: #2a313e;
            border-radius: 4px;
            transition: background-color 0.2s;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .goal-summary:hover {
            background-color: #373e49;
        }
        
        .goal-summary.editing {
            background-color: #1f2937;
            box-shadow: 0 0 0 2px #eab308;
        }
        
        .goal-emoji-display {
            font-size: 28px;
            min-width: 40px;
            text-align: center;
        }
        
        .goal-text-display {
            color: #d1d5db;
            flex: 1;
            font-size: 16px;
        }
        
        .remove-goal-btn {
            background: none;
            border: none;
            color: #6b7280;
            cursor: pointer;
            font-size: 20px;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            transition: all 0.2s;
        }
        
        .remove-goal-btn:hover {
            background-color: #374151;
            color: #ef4444;
        }
        
        .goal-editor {
            background-color: #1f2937;
            padding: 16px;
            border-radius: 4px;
            margin-top: 8px;
            border: 2px solid #eab308;
            position: relative;
            z-index: 60;
        }
        
        .goal-editor-section {
            margin-bottom: 16px;
        }
        
        .goal-editor-label {
            color: #d1d5db;
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 8px;
            display: block;
        }
        
        .goal-emoji-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, 44px);
            gap: 6px;
            max-height: 180px;
            overflow-y: auto;
        }
        
        .goal-emoji-btn {
            width: 44px;
            height: 44px;
            background: none;
            border: 2px solid transparent;
            border-radius: 6px;
            cursor: pointer;
            font-size: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            background-color: #374151;
        }
        
        .goal-emoji-btn:hover {
            background-color: #4b5563;
        }
        
        .goal-emoji-btn.selected {
            background-color: #3b82f6;
            border-color: #60a5fa;
        }
        
        .goal-controls-grid {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 12px;
            align-items: center;
        }
        
        .operator-value-group {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        
        .goal-operator-btn {
            background-color: #374151;
            color: #d1d5db;
            border: none;
            padding: 10px 16px;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.2s;
            font-size: 14px;
            min-width: 100px;
        }
        
        .goal-operator-btn:hover {
            background-color: #4b5563;
        }
        
        .goal-value-input {
            background-color: #374151;
            color: #d1d5db;
            border: none;
            padding: 10px 12px;
            border-radius: 6px;
            width: 80px;
            text-align: center;
            font-size: 14px;
        }
        
        .goal-value-input:focus {
            outline: none;
            background-color: #4b5563;
        }
        
        .goal-editor-actions {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        }
        
        .goal-action-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.2s;
        }
        
        .goal-action-btn.primary {
            background-color: #3b82f6;
            color: white;
        }
        
        .goal-action-btn.primary:hover {
            background-color: #2563eb;
        }
        
        .goal-action-btn.secondary {
            background-color: #374151;
            color: #d1d5db;
        }
        
        .goal-action-btn.secondary:hover {
            background-color: #4b5563;
        }
        
        /* EXPORT/IMPORT */
        .export-section {
            background-color: #2a313e;
            border-radius: 4px;
            overflow: hidden;
        }

        .export-toggle {
            width: 100%;
            background-color: #2a313e;
            color: white;
            border: none;
            padding: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .export-toggle:hover {
            background-color: #373e49;
        }
        
        .export-arrow {
            transition: transform 0.2s;
        }
        
        .export-arrow.open {
            transform: rotate(180deg);
        }
        
        .export-content {
            padding: 12px;
            background-color: #2a313e;
        }
        
        .import-section {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }
        
        .import-input {
            flex: 1;
            padding: 8px;
            background-color: #373e49;
            color: white;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .export-help {
            font-size: 12px;
            color: #aeb6c3;
            padding-top: 8px;
            border-top: 1px solid #373e49;
        }
        
        /* DAILY VIEW */
        .bubbles-container {
            border-radius: 8px;
            height: 192px;
            position: relative;
            overflow: hidden;
            border: 1px solid #2a313e;
            margin-bottom: 24px;
        }
        
        .bubble {
            position: absolute;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            color: white;
        }
        
        .dailies-section h3 {
            font-size: 18px;
            font-weight: 600;
            color: white;
            margin-bottom: 12px;
        }
        
        .no-goals-daily {
            color: #6b7280;
            font-size: 14px;
        }
        
        /* ANIMATIONS */
        @keyframes flash-border {
            0% { box-shadow: 0 0 0 2px white; }
            100% { box-shadow: none; }
        }
        
        .hour-entry.flash {
            animation: flash-border 0.5s ease;
        }
        
        /* MOBILE */
        @media (max-width: 768px) {
            .scroll-bar { display: none !important; }
            .header { padding: 0 16px; height: 54px; }
            .scroll-container, .settings-container, .daily-container { padding: 8px 16px; }
            .header h1 { font-size: 1.4em; }
            .btn { font-size: 1.3em !important; }
            .btn-label { font-size: 0.6em; }
            .date-nav { margin-bottom: 12px; }
            .secondary-btn, .date-input { font-size: 22px; }
            .date-input { width: 140px; }
            .hour-time { font-size: 20px; width: 28px; }
            .hour-emojis { grid-template-columns: repeat(2, 26px); gap: 2px; max-width: 54px; min-width: 54px; }
            .emoji { font-size: 24px; min-height: 24px; }
            .hour-text, .hour-input { font-size: 16px; }
            .emoji-picker { grid-template-columns: repeat(auto-fit, 42px); gap: 4px; padding: 8px; }
            .emoji-btn { width: 42px; height: 42px; font-size: 28px; }
            .setting-label, .setting-input, .checkbox-label { font-size: 16px; }
            .setting-input { padding: 10px; }
            .checkbox { width: 18px; height: 18px; }
            .bubble { font-size: 24px !important; }
            .dailies-section h3 { font-size: 16px; }
            .goal-emoji-display { font-size: 22px; }
            .goal-text-display { font-size: 16px; }
        }
        
        @media (max-width: 375px) {
            .header { padding: 0 12px; height: 48px; }
            .header h1 { font-size: 1.2em; }
            .btn { font-size: 1.2em !important; }
            .btn-label { font-size: 0.55em; }
            .scroll-container, .settings-container, .daily-container { padding: 8px 12px; }
            .hour-time { font-size: 18px; width: 24px; }
            .hour-emojis { grid-template-columns: repeat(2, 24px); max-width: 50px; min-width: 50px; }
            .emoji { font-size: 22px; min-height: 22px; }
            .hour-text, .hour-input { font-size: 16px; }
            .emoji-picker { grid-template-columns: repeat(4, 1fr); gap: 4px; padding: 6px; }
            .emoji-btn { padding: 4px; font-size: 24px; }
            .date-input, .secondary-btn { font-size: 18px; }
        }
    </style>
</head>
<body>
    <div id="app">
        <div class="header">
            <span style="display: flex; align-items: start; gap: 16px;">
                <h1 onclick="app.setView('timeline')"><div class="btn-active" id="floatingNavDate">hourlies</div></h1>
                <button class="btn" onclick="app.undo()" id="undoBtn" style="display: none;">↶</button>
            </span>
            <div class="header-buttons">
                <button class="btn" onclick="app.setView('daily')">🎯 <span class="btn-label">daily</span></button>
                <button class="btn" onclick="app.setView('settings')">⚙ <span class="btn-label">edit</span></button>
            </div>
        </div>
        <div class="main-container" id="mainContainer"></div>
    </div>

    <script>
        class HourliesApp {

            constructor() {
                this.currentTime = new Date();
                this.startHour = 7;
                this.allEntries = {};
                this.goals = [];
                this.emojis = ['☕', '📖', '😴', '🎮', '🍕', '💊', '🌿', '🔴', '🟩', '📷'];
                this.showGoalsInTimeline = false;
                
                this.currentDate = new Date();
                this.editingHour = null;
                this.editingGoal = null;
                this.view = 'timeline';
                this.undoStack = [];
                this.clipboardEntry = null;
                this.timelineScrollPosition = 0;

                this.loadData();
                this.currentDate = this.getEffectiveDate();
                this.render();
                this.startTimer();
                this.setupEvents();
                setTimeout(() => this.scrollToCurrentHour(), 100);
            }

            // === DATA ===
            loadData() {
                const saved = localStorage.getItem("hourliesData");
                if (saved) {
                    try {
                        const data = JSON.parse(saved);
                        Object.assign(this, {
                            allEntries: data.allEntries || {},
                            goals: data.goals || [],
                            emojis: data.emojis || this.emojis,
                            startHour: data.startHour ?? this.startHour,
                            showGoalsInTimeline: data.showGoalsInTimeline ?? false
                        });
                    } catch (e) {
                        console.warn("Failed to load saved data", e);
                    }
                } else {
                    this.createWelcomeMessage();
                }
            }

            createWelcomeMessage() {
                const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
                const welcomeEntries = {
                    7: { emojis: ['👋'], text: 'welcome to hourlies' },
                    8: { emojis: ['📊'], text: 'track your daily activities with emojis and text' },
                    10: { emojis: ['✏️'], text: 'click any hour to add what you did' },
                    12: { emojis: ['📄'], text: isMobile ? 'long tap to copy filled hour' : 'right click to copy filled hour' },
                    13: { emojis: ['📋'], text: 'repeat on empty hour to paste' },
                    15: { emojis: ['⚙️'], text: 'go to edit to customize emojis and dailies' },
                    16: { emojis: ['🎯'], text: 'dailies are simple rules for tracking habits' },
                    18: { emojis: ['🏠'], text: 'daily view shows your patterns visually' },
                    19: { emojis: ['🗑️'], text: 'wipe current day there to start fresh' }
                };
                this.allEntries[this.currentDateKey] = welcomeEntries;
            }

            saveData() {
                localStorage.setItem("hourliesData", JSON.stringify({
                    allEntries: this.allEntries,
                    goals: this.goals,
                    emojis: this.emojis,
                    startHour: this.startHour,
                    showGoalsInTimeline: this.showGoalsInTimeline
                }));
            }

            updateEntries(newEntries) {
                this.undoStack.push({ entries: { ...this.entries }, timestamp: Date.now() });
                if (this.undoStack.length > 10) this.undoStack.shift();
                
                // Split entries into correct calendar days
                const currentDayKey = this.dateKey(this.currentDate);
                const nextDay = new Date(this.currentDate);
                nextDay.setDate(nextDay.getDate() + 1);
                const nextDayKey = this.dateKey(nextDay);
                
                // Initialize storage objects
                if (!this.allEntries[currentDayKey]) this.allEntries[currentDayKey] = {};
                if (!this.allEntries[nextDayKey]) this.allEntries[nextDayKey] = {};
                
                // Store entries in correct calendar days
                Object.entries(newEntries).forEach(([hour, entry]) => {
                    const hourNum = parseInt(hour);
                    if (hourNum >= this.startHour) {
                        // Hours 7-23 go to current calendar day
                        this.allEntries[currentDayKey][hourNum] = entry;
                    } else {
                        // Hours 0-6 go to next calendar day
                        this.allEntries[nextDayKey][hourNum] = entry;
                    }
                });
                
                this.updateUndoButton();
                this.saveData();
            }

            // === UTILITIES ===
            dateKey(date) { return date ? date.toISOString().split('T')[0] : ''; }
            
            get currentDateKey() { 
                // For data storage, we need to account for hours that belong to previous day
                const effectiveDate = new Date(this.currentDate);
                return this.dateKey(effectiveDate);
            }
            
            get entries() { 
                // Get entries for the current logical day
                const currentDayEntries = this.allEntries[this.currentDateKey] || {};
                const nextDay = new Date(this.currentDate);
                nextDay.setDate(nextDay.getDate() + 1);
                const nextDayKey = this.dateKey(nextDay);
                const nextDayEntries = this.allEntries[nextDayKey] || {};
                
                // Combine entries: hours 0-6 from next calendar day + hours 7-23 from current day
                const combinedEntries = {};
                
                // Add hours 7-23 from current calendar day
                for (let hour = this.startHour; hour < 24; hour++) {
                    if (currentDayEntries[hour]) {
                        combinedEntries[hour] = currentDayEntries[hour];
                    }
                }
                
                // Add hours 0-(startHour-1) from next calendar day
                for (let hour = 0; hour < this.startHour; hour++) {
                    if (nextDayEntries[hour]) {
                        combinedEntries[hour] = nextDayEntries[hour];
                    }
                }
                
                return combinedEntries;
            }
            
            get hours() { return Array.from({length: 24}, (_, i) => (this.startHour + i) % 24); }
            formatHour(hour) { return hour.toString().padStart(2, '0'); }
            
            formatDateInput() {
                if (!this.currentDate) return '';
                // The date input should show the logical day date 
                // (the date that this day period represents)
                return [
                    this.currentDate.getDate().toString().padStart(2, '0'),
                    (this.currentDate.getMonth() + 1).toString().padStart(2, '0'),
                    this.currentDate.getFullYear().toString().slice(-2)
                ].join('/');
            }

            getEffectiveDate() {
                // Get the current logical day based on start hour
                const d = new Date(this.currentTime);
                if (d.getHours() < this.startHour) {
                    d.setDate(d.getDate() - 1);
                }
                return d;
            }

            isCurrentDate() { return this.dateKey(this.getEffectiveDate()) === this.currentDateKey; }
            isPastDate() { return this.dateKey(this.currentDate) < this.dateKey(this.getEffectiveDate()); }
            isFutureDate() { return this.dateKey(this.currentDate) > this.dateKey(this.getEffectiveDate()); }

            getHourFill(hour) {
                if (this.isFutureDate()) return 0;
                if (this.isPastDate()) return 100;
                if (!this.isCurrentDate()) return 0;
                
                const currentHour = this.currentTime.getHours();
                const adjustedHour = hour < this.startHour ? hour + 24 : hour;
                const adjustedCurrentHour = currentHour < this.startHour ? currentHour + 24 : currentHour;
                
                if (adjustedHour < adjustedCurrentHour) return 100;
                if (adjustedHour === adjustedCurrentHour) return (this.currentTime.getMinutes() / 60) * 100;
                return 0;
            }

            isCurrentHour(hour) {
                return this.isCurrentDate() && this.currentTime.getHours() === hour;
            }

            // === EVENTS ===
            setupEvents() {
                document.addEventListener('click', (e) => {
                    if (this.editingHour === null) return;
                    const isInterface = e.target.classList.contains('overlay') ||
                                      e.target.classList.contains('hour-input') ||
                                      e.target.classList.contains('clear-btn') ||
                                      e.target.classList.contains('emoji-btn');
                    if (!isInterface) {
                        e.preventDefault();
                        setTimeout(() => {
                            const textarea = document.querySelector(`[data-hour="${this.editingHour}"] textarea`);
                            if (textarea) {
                                textarea.focus();
                                textarea.selectionStart = textarea.selectionEnd = textarea.value.length;
                            }
                        }, 0);
                    }
                });
            }

            // === NAVIGATION ===
            navigateDay(direction) {
                this.currentDate.setDate(this.currentDate.getDate() + direction);
                this.editingHour = null;
                this.render();
            }

            jumpToToday() {
                this.currentDate = this.getEffectiveDate();
                this.editingHour = null;
                this.render();
                setTimeout(() => this.scrollToCurrentHour(), 100);
            }

            setView(view) {
                if (this.view === 'timeline' && view !== 'timeline') {
                    const container = document.querySelector('.scroll-container');
                    if (container) this.timelineScrollPosition = container.scrollTop;
                }

                this.view = view;
                this.editingHour = null;
                this.editingGoal = null;
                this.updateHeaderTitle();
                this.render();
            }

            updateHeaderTitle() {
                const floatingNavDate = document.getElementById('floatingNavDate');
                if (!floatingNavDate) return;

                if (this.view === 'timeline') {
                    floatingNavDate.textContent = "hourlies";
                    floatingNavDate.classList.add('btn-active');
                } else {
                    floatingNavDate.textContent = "← " + this.formatNavbarDate(this.currentDate).toLowerCase();
                    floatingNavDate.classList.remove('btn-active');
                }
            }

            handleScroll(e) {
                const scrolled = e.target.scrollTop > 150;
                const floatingNavDate = document.getElementById('floatingNavDate');
                
                if (floatingNavDate && this.view === 'timeline') {
                    if (scrolled) {
                        floatingNavDate.textContent = this.formatNavbarDate(this.currentDate).toLowerCase();
                    } else {
                        floatingNavDate.textContent = "hourlies";
                    }
                    floatingNavDate.classList.add('btn-active');
                }
            }

            // === DATE INPUT ===
            handleDateInput(event) {
                const value = event.target.value.replace(/\D/g, '');
                event.target.value = value.match(/.{1,2}/g)?.join('/') || value;

                const parseAndSetDate = (value, useCurrentYear = false) => {
                    const day = parseInt(value.slice(0, 2), 10);
                    const month = parseInt(value.slice(2, 4), 10) - 1;
                    const year = useCurrentYear ? this.currentTime.getFullYear() : 2000 + parseInt(value.slice(4, 6), 10);

                    // Set currentDate and currentTime to the user's entered date
                    const inputDate = new Date(year, month, day, 12, 0, 0);

                    if (!isNaN(inputDate.getTime()) && day > 0 && day <= 31 && month >= 0 && month < 12) {
                        this.currentDate = new Date(year, month, day);
                        this.currentTime = new Date(year, month, day, 12, 0, 0);
                        // Remove any override of getEffectiveDate, always use the default logic
                        delete this.getEffectiveDate;
                        event.target.value = this.formatDateInput();
                        this.render();
                        return true;
                    }
                    return false;
                };

                if (value.length === 4 && (event.type === 'blur' || event.key === 'Enter')) {
                    if (!parseAndSetDate(value, true)) {
                        event.target.value = this.formatDateInput();
                    }
                } else if (value.length === 6) {
                    parseAndSetDate(value);
                }
            }

            formatNavbarDate(date) {
                return date.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' }).toLowerCase();
            }

            handleDateKeydown(event) {
                const allowed = ['Backspace', 'Delete', 'ArrowLeft', 'ArrowRight', 'Tab', 'Enter', 'Escape'];
                if (!/^\d$/.test(event.key) && !allowed.includes(event.key)) {
                    event.preventDefault();
                }
                if (event.key === 'Enter') {
                    event.preventDefault();
                    event.target.blur();
                } else if (event.key === 'Escape') {
                    event.preventDefault();
                    event.target.value = this.formatDateInput();
                    event.target.blur();
                }
            }

            handleDateFocus(event) {
                event.target.select();
                event.target.addEventListener('blur', (e) => this.handleDateInput(e), { once: true });
            }

            // === HOURS ===
            editHour(hour) {
                if (this.editingHour === hour) return;
                this.editingHour = hour;
                this.renderHours();
                
                setTimeout(() => {
                    const hourElement = document.querySelector(`[data-hour="${hour}"]`);
                    const textarea = hourElement?.querySelector('textarea');
                    if (textarea) {
                        if (window.innerWidth <= 768) {
                            const container = document.querySelector('.scroll-container');
                            const containerRect = container.getBoundingClientRect();
                            const elementRect = hourElement.getBoundingClientRect();
                            const relativeTop = elementRect.top - containerRect.top;
                            const targetPosition = containerRect.height * 0.15;
                            container.scrollTop = container.scrollTop + (relativeTop - targetPosition);
                        } else {
                            hourElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }
                        
                        setTimeout(() => {
                            textarea.focus();
                            textarea.selectionStart = textarea.selectionEnd = textarea.value.length;
                        }, 300);
                    }
                }, 50);
            }

            updateText(text) {
                const entry = this.entries[this.editingHour] || { emojis: [], text: '' };
                const newEntries = { ...this.entries };
                newEntries[this.editingHour] = { ...entry, text };
                
                this.undoStack.push({ entries: { ...this.entries }, timestamp: Date.now() });
                if (this.undoStack.length > 10) this.undoStack.shift();
                this.allEntries[this.currentDateKey] = newEntries;
                this.updateUndoButton();
                this.saveData();
            }

            clearEntry(hour) {
                const newEntries = { ...this.entries };
                newEntries[hour] = { emojis: [], text: '' };
                this.updateEntries(newEntries);
                this.editingHour = null;
                this.renderHours();
            }

            toggleEmoji(emoji) {
                const entry = this.entries[this.editingHour] || { emojis: [], text: '' };
                const validEmojis = entry.emojis.filter(e => this.emojis.includes(e));
                const newEmojis = validEmojis.includes(emoji) 
                    ? validEmojis.filter(e => e !== emoji)
                    : [...validEmojis, emoji];
                
                const newEntries = { ...this.entries };
                newEntries[this.editingHour] = { ...entry, emojis: newEmojis };
                this.updateEntries(newEntries);
                this.renderHours();
                
                setTimeout(() => {
                    const textarea = document.querySelector(`[data-hour="${this.editingHour}"] textarea`);
                    if (textarea) {
                        textarea.focus();
                        textarea.selectionStart = textarea.selectionEnd = textarea.value.length;
                    }
                }, 50);
            }

            handleHourInputKeydown(event, hour) {
                if (event.key === 'Enter' && !event.shiftKey) {
                    event.preventDefault();
                    this.editingHour = null;
                    this.renderHours();
                } else if (event.key === 'ArrowUp' || event.key === 'ArrowDown') {
                    const textarea = event.target;
                    const cursorAtEnd = textarea.selectionStart === textarea.value.length;
                    
                    // Only navigate if cursor is at the very end of the text
                    if (cursorAtEnd) {
                        event.preventDefault();
                        const currentIndex = this.hours.indexOf(hour);
                        const nextIndex = event.key === 'ArrowUp' 
                            ? (currentIndex - 1 + this.hours.length) % this.hours.length
                            : (currentIndex + 1) % this.hours.length;
                        const nextHour = this.hours[nextIndex];

                        this.editingHour = nextHour;
                        this.renderHours();
                        
                        setTimeout(() => {
                            const nextTextarea = document.querySelector(`[data-hour="${nextHour}"] textarea`);
                            if (nextTextarea) {
                                nextTextarea.focus();
                                nextTextarea.selectionStart = nextTextarea.selectionEnd = nextTextarea.value.length;
                            }
                        }, 0);
                    }
                }
            }

            // === COPY/PASTE ===
            handleCopyPaste(hour, entry, element) {
                const hasContent = (entry.text && entry.text.trim()) || (entry.emojis && entry.emojis.length > 0);

                if (hasContent) {
                    this.clipboardEntry = {
                        emojis: entry.emojis ? [...entry.emojis] : [],
                        text: entry.text || ""
                    };
                    element.classList.add("flash");
                    setTimeout(() => element.classList.remove("flash"), 500);
                } else if (this.clipboardEntry) {
                    const newEntries = { ...this.entries };
                    newEntries[hour] = { ...this.clipboardEntry };
                    this.updateEntries(newEntries);
                    this.renderHours();
                }
            }

            attachCopyPasteEvents() {
                document.querySelectorAll(".hour-entry").forEach(el => {
                    const hour = parseInt(el.dataset.hour);
                    const entry = this.entries[hour] || { emojis: [], text: "" };

                    el.addEventListener("contextmenu", (e) => {
                        e.preventDefault();
                        this.handleCopyPaste(hour, entry, el);
                    });

                    let longPressTimer;
                    el.addEventListener("touchstart", () => {
                        longPressTimer = setTimeout(() => {
                            this.handleCopyPaste(hour, entry, el);
                            el._suppressClick = true;
                        }, 500);
                    });
                    
                    el.addEventListener("touchend", () => clearTimeout(longPressTimer));
                    el.addEventListener("touchmove", () => clearTimeout(longPressTimer));

                    el.addEventListener("click", (e) => {
                        if (el._suppressClick) {
                            e.stopImmediatePropagation();
                            el._suppressClick = false;
                        }
                    }, true);
                });
            }

            // === GOALS ===
            addGoal() {
                const newGoal = {
                    id: Date.now(),
                    emoji: '📖',
                    operator: 'more_than',
                    value: 1
                };
                this.goals.push(newGoal);
                this.renderSettings();
            }

            updateGoal(id, updates) {
                this.goals = this.goals.map(goal => goal.id === id ? { ...goal, ...updates } : goal);
                this.saveData();
                this.renderSettings();
            }

            removeGoal(id) {
                this.goals = this.goals.filter(goal => goal.id !== id);
                this.saveData();
                this.renderSettings();
            }

            editGoal(id) {
                this.editingGoal = this.editingGoal === id ? null : id;
                this.renderSettings();
            }

            cycleOperator(goalId) {
                const goal = this.goals.find(g => g.id === goalId);
                const operators = ['more_than', 'less_than', 'before', 'after'];
                const currentIndex = operators.indexOf(goal.operator);
                const nextIndex = (currentIndex + 1) % operators.length;
                this.updateGoal(goalId, { operator: operators[nextIndex] });
            }

            formatGoalText(goal) {
                const opText = goal.operator.replace('_', ' ');
                const suffix = goal.operator.includes('than') ? ' times' : '';
                return `${opText} ${goal.value}${suffix}`;
            }

            checkGoals() {
                const dayEntries = Object.values(this.entries);
                return this.goals.map(goal => {
                    const emojiCount = dayEntries.reduce((count, entry) => {
                        return count + (entry.emojis?.filter(e => e === goal.emoji).length || 0);
                    }, 0);
                    
                    const emojiHours = Object.keys(this.entries).filter(hour => 
                        this.entries[hour].emojis?.includes(goal.emoji)
                    ).map(Number);
                    
                    let met = false;
                    
                    if (goal.operator === 'more_than') {
                        met = emojiCount > goal.value;
                    } else if (goal.operator === 'less_than') {
                        met = emojiCount < goal.value;
                    } else if (goal.operator === 'before' && emojiHours.length > 0) {
                        // Adjust hours for start time
                        const adjustedHours = emojiHours.map(h => h < this.startHour ? h + 24 : h);
                        const adjustedTarget = goal.value < this.startHour ? goal.value + 24 : goal.value;
                        met = Math.min(...adjustedHours) < adjustedTarget;
                    } else if (goal.operator === 'after' && emojiHours.length > 0) {
                        // Adjust hours for start time  
                        const adjustedHours = emojiHours.map(h => h < this.startHour ? h + 24 : h);
                        const adjustedTarget = goal.value < this.startHour ? goal.value + 24 : goal.value;
                        met = Math.max(...adjustedHours) > adjustedTarget;
                    }
                    
                    return { ...goal, met, emojiCount };
                });
            }

            // === TIMER ===
            startTimer() {
                setInterval(() => {
                    this.currentTime = new Date();
                    const effectiveDate = this.getEffectiveDate();
                    if (this.dateKey(effectiveDate) !== this.currentDateKey) {
                        this.currentDate = effectiveDate;
                    }
                    if (this.view === 'timeline' && this.editingHour === null) {
                        this.renderHours();
                    }
                }, 60000);
            }

            undo() {
                if (this.undoStack.length === 0) return;
                const lastState = this.undoStack.pop();
                
                // Apply the undo state using the same logic as updateEntries
                const currentDayKey = this.dateKey(this.currentDate);
                const nextDay = new Date(this.currentDate);
                nextDay.setDate(nextDay.getDate() + 1);
                const nextDayKey = this.dateKey(nextDay);
                
                // Clear current entries
                if (this.allEntries[currentDayKey]) {
                    for (let hour = this.startHour; hour < 24; hour++) {
                        delete this.allEntries[currentDayKey][hour];
                    }
                }
                if (this.allEntries[nextDayKey]) {
                    for (let hour = 0; hour < this.startHour; hour++) {
                        delete this.allEntries[nextDayKey][hour];
                    }
                }
                
                // Restore entries
                Object.entries(lastState.entries).forEach(([hour, entry]) => {
                    const hourNum = parseInt(hour);
                    if (hourNum >= this.startHour) {
                        if (!this.allEntries[currentDayKey]) this.allEntries[currentDayKey] = {};
                        this.allEntries[currentDayKey][hourNum] = entry;
                    } else {
                        if (!this.allEntries[nextDayKey]) this.allEntries[nextDayKey] = {};
                        this.allEntries[nextDayKey][hourNum] = entry;
                    }
                });
                
                this.updateUndoButton();
                this.renderHours();
                this.saveData();
            }

            updateUndoButton() {
                const undoBtn = document.getElementById('undoBtn');
                if (undoBtn) {
                    undoBtn.style.display = this.view === 'timeline' && this.undoStack.length > 0 ? 'block' : 'none';
                }
            }

            scrollToCurrentHour() {
                const container = document.querySelector('.scroll-container');
                if (!container) return;
                const currentHourIndex = this.hours.findIndex(hour => hour === this.currentTime.getHours());
                if (currentHourIndex === -1) return;
                const hourElements = container.querySelectorAll('[data-hour]');
                const targetElement = hourElements[currentHourIndex];
                if (targetElement) {
                    targetElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }

            // === EXPORT ===
            exportCurrentDayCSV() {
                let content = "";
                this.hours.forEach(hour => {
                    const entry = this.entries[hour];
                    const emojis = entry?.emojis?.join('') || '';
                    const text = entry?.text || '';
                    content += `${emojis} ${text}\n`;
                });
                
                try {
                    navigator.clipboard.writeText(content);
                } catch (err) {
                    const blob = new Blob([content], { type: 'text/csv' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `hourlies-${this.formatDateInput()}.csv`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                }
            }

            wipeCurrentDayData() {
                // Clear entries for the current logical day
                const currentDayKey = this.dateKey(this.currentDate);
                const nextDay = new Date(this.currentDate);
                nextDay.setDate(nextDay.getDate() + 1);
                const nextDayKey = this.dateKey(nextDay);
                
                // Clear hours 7-23 from current calendar day
                if (this.allEntries[currentDayKey]) {
                    for (let hour = this.startHour; hour < 24; hour++) {
                        delete this.allEntries[currentDayKey][hour];
                    }
                }
                
                // Clear hours 0-6 from next calendar day
                if (this.allEntries[nextDayKey]) {
                    for (let hour = 0; hour < this.startHour; hour++) {
                        delete this.allEntries[nextDayKey][hour];
                    }
                }
                
                this.render();
                this.saveData();
            }

            getDayEmojis() {
                const emojiCounts = {};
                Object.values(this.entries).forEach(entry => {
                    if (entry.emojis) {
                        entry.emojis.forEach(emoji => {
                            emojiCounts[emoji] = (emojiCounts[emoji] || 0) + 1;
                        });
                    }
                });
                return emojiCounts;
            }

            // === RENDER ===
            render() {
                this.updateUndoButton();
                this.checkGoals(); // Always update/check dailies on UI update

                if (this.view === 'timeline') {
                    this.renderTimeline();
                } else if (this.view === 'settings') {
                    this.renderSettings();
                } else if (this.view === 'daily') {
                    this.renderDaily();
                }
            }

            renderTimeline() {
                document.getElementById('mainContainer').innerHTML = `
                    <div class="scroll-container">
                        <div class="date-nav">
                            <div class="date-nav-left">
                                <div class="date-btn" onclick="app.navigateDay(-1)">←</div>
                                <input type="text" 
                                    class="date-input secondary-btn"
                                    value="${this.formatDateInput()}"
                                    maxlength="8"
                                    onkeydown="app.handleDateKeydown(event)"
                                    oninput="app.handleDateInput(event)"
                                    onfocus="app.handleDateFocus(event)">
                                <div class="date-btn" onclick="app.navigateDay(1)">→</div>
                            </div>
                            <div class="date-nav-right">
                                <button class="jump-btn" onclick="app.jumpToToday()">now</button>
                                <button class="btn" onclick="app.exportCurrentDayCSV()">📋</button>
                            </div>
                        </div>
                        
                        <div id="goalsSection"></div>
                        <div id="hoursContainer"></div>
                    </div>
                    
                    <div class="scroll-bar ${this.editingHour !== null ? 'hidden' : ''}"></div>
                `;

                const container = document.querySelector('.scroll-container');
                container.addEventListener('scroll', this.handleScroll.bind(this));
                if (this.timelineScrollPosition > 0) {
                    container.scrollTop = this.timelineScrollPosition;
                }

                this.renderGoals();
                this.renderHours();
            }

            renderGoals() {
                const goalsSection = document.getElementById('goalsSection');
                if (!goalsSection) return;
                
                const goalChecks = this.checkGoals();

                if (this.goals.length > 0 && this.showGoalsInTimeline) {
                    goalsSection.innerHTML = `
                        <div class="goals-section">
                            <h2 class="goals-title">dailies</h2>
                            ${goalChecks.map(goal => `
                                <div class="goal-item ${goal.met ? 'passed' : 'failed'}">
                                    <span class="goal-emoji-display">${goal.emoji}</span>
                                    <span class="goal-text">${this.formatGoalText(goal)}</span>
                                </div>
                            `).join('')}
                        </div>
                    `;
                } else if (this.goals.length === 0 && this.showGoalsInTimeline) {
                    goalsSection.innerHTML = '<div class="no-goals">no dailies set - add in settings</div>';
                } else {
                    goalsSection.innerHTML = '';
                }
            }

            renderHours() {
                this.saveData();
                const hoursContainer = document.getElementById('hoursContainer');
                if (!hoursContainer) return;
                
                hoursContainer.innerHTML = `
                    <div class="hours-container">
                        ${this.hours.map(hour => {
                            const entry = this.entries[hour] || { emojis: [], text: '' };
                            const isCurrent = this.isCurrentHour(hour);
                            const isEditing = this.editingHour === hour;
                            const hourFill = this.getHourFill(hour);
                            const emojis = (entry.emojis || []).slice(0, 6);

                            return `
                                <div class="hour-row">
                                    ${isEditing ? `
                                        <div class="emoji-picker below">
                                            ${this.emojis.map(emoji => `
                                                <button class="emoji-btn ${entry.emojis?.includes(emoji) ? 'selected' : ''}"
                                                        onclick="app.toggleEmoji('${emoji}')">
                                                    ${emoji}
                                                </button>
                                            `).join('')}
                                        </div>
                                    ` : ''}
                                    
                                    <div class="hour-entry ${isCurrent ? 'current' : ''} ${isEditing ? 'editing' : ''}"
                                         data-hour="${hour}"
                                         onclick="app.editHour(${hour})">
                                        ${hourFill > 0 ? `<div class="hour-fill ${!entry.text && !entry.emojis?.length ? 'empty' : ''}" style="width: ${hourFill}%;"></div>` : ''}
                                        <div class="hour-content">
                                            <span class="hour-time">${this.formatHour(hour)}</span>
                                            <div class="hour-emojis">
                                                ${emojis.map(emoji => `<span class="emoji">${emoji}</span>`).join('')}
                                            </div>
                                            ${isEditing ? `
                                                <div class="hour-input-container">
                                                    <textarea class="hour-input"
                                                           placeholder="${this.isFutureDate() ? 'Plan ahead...' : this.isPastDate() ? 'Remember...' : 'What happened?'}"
                                                           oninput="app.updateText(this.value)"
                                                           onkeydown="app.handleHourInputKeydown(event, ${hour})"
                                                           onclick="event.stopPropagation()">${entry.text}</textarea>
                                                    <button class="clear-btn" onclick="event.stopPropagation(); app.clearEntry(${hour})">×</button>
                                                </div>
                                            ` : `<span class="hour-text">${entry.text}</span>`}
                                        </div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                        ${this.editingHour !== null ? '<div class="overlay" onclick="app.editingHour = null; app.renderHours()"></div>' : ''}
                    </div>
                `;
                this.attachCopyPasteEvents();
            }

            renderSettings() {
                document.getElementById('mainContainer').innerHTML = `
                    <div class="settings-container">
                        <div class="setting-group">
                            <label class="setting-label">Available Emojis</label>
                            <input type="text" class="setting-input" value="${this.emojis.join('')}"
                                   oninput="app.emojis = [...this.value]; app.saveData()">
                        </div>
                        
                        <div class="setting-group">
                            <label class="setting-label">Dailies</label>
                            <div id="goalsList"></div>
                            <button class="add-goal-btn" onclick="app.addGoal()" style="margin-top: 12px;">+ Add Daily</button>
                        </div>

                        <div class="setting-group">
                            <label class="checkbox-label">
                                <input type="checkbox" class="checkbox" ${this.showGoalsInTimeline ? 'checked' : ''}
                                       onchange="app.showGoalsInTimeline = this.checked; app.saveData()">
                                <span>Show dailies in timeline</span>
                            </label>
                        </div>

                        <div class="setting-group">
                            <label class="setting-label">Start Hour</label>
                            <select class="setting-input" onchange="app.startHour = parseInt(this.value); app.saveData()">
                                ${Array.from({length: 24}, (_, i) => `
                                    <option value="${i}" ${i === this.startHour ? 'selected' : ''}>
                                        ${this.formatHour(i)}:00
                                    </option>
                                `).join('')}
                            </select>
                        </div>
                        
                        ${this.editingGoal !== null ? '<div class="overlay" onclick="app.editingGoal = null; app.renderSettings()"></div>' : ''}
                    </div>
                `;

                this.renderGoalsList();
            }

            renderGoalsList() {
                const goalsList = document.getElementById('goalsList');
                if (!goalsList) return;
                
                goalsList.innerHTML = this.goals.map(goal => {
                    const isEditing = this.editingGoal === goal.id;
                    return `
                        <div class="goal-row" style="width:100%">
                            <div class="goal-summary ${isEditing ? 'editing' : ''}" onclick="app.editGoal(${goal.id})" style="width:100%">
                                <span class="goal-emoji-display">${goal.emoji}</span>
                                <span class="goal-text-display">${this.formatGoalText(goal)}</span>
                                <button class="remove-goal-btn" onclick="event.stopPropagation(); app.removeGoal(${goal.id})">×</button>
                            </div>
                            ${isEditing ? `
                                <div class="goal-editor" style="width:100%">
                                    <div class="goal-editor-section" style="width:100%">
                                        <div class="goal-emoji-grid" style="width:100%">
                                            ${this.emojis.map(emoji => `
                                                <button class="goal-emoji-btn ${goal.emoji === emoji ? 'selected' : ''}"
                                                        onclick="app.updateGoal(${goal.id}, { emoji: '${emoji}' })">
                                                    ${emoji}
                                                </button>
                                            `).join('')}
                                        </div>
                                    </div>
                                    <div class="goal-editor-section" style="width:100%">
                                        <div class="goal-controls-grid" style="width:100%">
                                            <div class="operator-value-group" style="width:100%; display:flex; gap:8px; align-items:center;">
                                                <button class="goal-action-btn secondary" style="margin-left:12px;" onclick="app.toggleGoalNegation(${goal.id})">
                                                    ${goal.not ? 'is not' : 'is'}
                                                </button>
                                                <button class="goal-operator-btn" onclick="app.cycleOperator(${goal.id})">
                                                    ${goal.operator.replace('_', ' ')}
                                                </button>
                                                <input type="number" 
                                                       class="goal-value-input" 
                                                       value="${goal.value}" 
                                                       min="0" 
                                                       max="23"
                                                       onclick="event.stopPropagation()"
                                                       onblur="app.updateGoal(${goal.id}, { value: parseInt(this.value) || 0 })">
                                                <span style="color: #9ca3af; font-size: 14px;">
                                                    ${goal.operator.includes('than') ? 'times' : ''}
                                                </span>
                                                
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    `;
                }).join('');
            }
            toggleGoalNegation(goalId) {
                const goal = this.goals.find(g => g.id === goalId);
                this.updateGoal(goalId, { not: !goal.not });
            }
            

            renderDaily() {
                const dayEmojis = this.getDayEmojis();
                const goalChecks = this.checkGoals();
                
                document.getElementById('mainContainer').innerHTML = `
                    <div class="daily-container">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 16px;">
                            <button class="jump-btn" onclick="if(confirm('Clear all data for this day?')) { app.wipeCurrentDayData(); }">🗑️ wipe</button>
                            <button class="jump-btn" onclick="app.exportCurrentDayCSV()">📋 copy</button>
                        </div>
                        
                        <div class="bubbles-container">
                            ${Object.entries(dayEmojis).map(([emoji, count], index) => {
                                const maxCount = Math.max(...Object.values(dayEmojis), 1);
                                const size = 30 + (count / maxCount) * 40;
                                const x = (index * 80 + 50) % 300;
                                const y = 30 + (index * 50) % 120;
                                return `
                                    <div class="bubble" style="
                                        left: ${x}px; 
                                        top: ${y}px; 
                                        width: ${size}px; 
                                        height: ${size}px; 
                                        font-size: ${size * 0.5}px
                                    ">
                                        ${emoji}
                                    </div>
                                `;
                            }).join('')}
                        </div>
                        
                        <div class="dailies-section">
                            <h3>Dailies</h3>
                            ${goalChecks.map(goal => `
                                <div class="goal-item ${goal.met ? 'passed' : 'failed'}" style="font-size:18px; font-weight:500; margin-bottom:8px;">
                                    <span class="goal-emoji-display">${goal.emoji}</span>
                                    <span class="goal-text">${this.formatGoalText(goal)} (${goal.emojiCount})</span>
                                </div>
                            `).join('')}
                            ${this.goals.length === 0 ? '<p class="no-goals-daily">No dailies set</p>' : ''}
                        </div>
                    </div>
                `;
            }
        }

        const app = new HourliesApp();
    </script>
</body>
</html>
