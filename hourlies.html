<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hourlies</title>
    <!-- Space Mono font from Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }
        
        body {
            font-family: 'Space Mono', monospace;
            background-color: #111827;
            color: white;
            height: 100vh;
            margin: 0;
            overflow: hidden;
        }
        html {
            height: 100%;
            overflow: hidden;
        }
        
        .header {
            background-color: #1f2937;
            padding: 0px 12%;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header h1 {
            font-size: 1.7em;
            font-weight: 600;
            cursor: pointer;
            transition: color 0.2s;
            color: #aeb6c3;
            cursor: pointer;
        }
        
        .header h1:hover {
            color: white;
        }
        
        .header-buttons,.btn {
            font-size: 1.55em !important;
        }   
        .header-buttons {
            display: flex;
            gap: 16px;
            align-items: center;
        }
        .btn-label {
            font-size: 0.65em;
            vertical-align: middle;
        }
        
        .btn {
            background: none;
            border: none;
            color: #aeb6c3;
            cursor: pointer;
            transition: color 0.2s;
        }
        
        .btn-active {
            color: white;
            font-weight: 500;
        }
        .btn:hover {
            color: white;
        }
        
        .btn.large {
            font-size: 1.4em;
            color: white;
        }

        .main-container {
            height: calc(100vh - 72px);
            position: relative;
        }
        
        .scroll-container, .settings-container, .daily-container {
            padding: 16px 12%;
            height: 100%;
            overflow-y: auto;
        }
        
        .date-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        
        .date-nav-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .date-nav-right {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .secondary-btn {
            font-size: 32px;
        }
        .date-btn {
            background: none;
            border: none;
            color: #aeb6c3;
            cursor: pointer;
            transition: color 0.2s;
        }
        
        .date-btn:hover {
            color: white;
        }
        
        .date-input {
            background: none;
            border: none;
            color: #aeb6c3;
            font-family: inherit;
            font-size: 32px;
            text-align: center;
            width: 160px;
            transition: color 0.2s;
            cursor: pointer;
        }
        
        .date-input:focus {
            outline: none;
            color: white;
        }

        /* Remove spinners from number inputs */
        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type=number] {
            -webkit-appearance: textfield;
            -moz-appearance: textfield;
            appearance: textfield;
        }
        
        .jump-btn {
            background-color: #1f2937;
            color: #6b7280;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            transition: color 0.2s;
        }
        
        .jump-btn:hover {
            color: #d1d5db;
        }
        
        .goals-section {
            margin-bottom: 24px;
            padding: 12px;
            background-color: #1f2937;
            border-radius: 8px;
        }
        
        .goals-title {
            font-weight: 600;
            color: #60a5fa;
            margin-bottom: 8px;
        }
        
        .goal-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            margin-bottom: 4px;
            padding: 4px 8px;
            border-radius: 4px;
        }
        
        .goal-item.passed {
            background-color: #364e36;
        }
        
        .goal-item.failed {
            background-color: #5f3b3b;
        }
        
        .goal-status {
            font-size: 14px;
        }
        
        .goal-text {
            color: #d1d5db;
            font-size: 1.4em;
            font-weight: 500;
        }
        
        .no-goals {
            padding: 8px 12px;
            border-radius: 4px;
            background-color: #2a313e;
            color: #6b7280;
            text-align: center;
            font-size: 14px;
        }
        
        .hours-container {
            position: relative;
        }
        
        .hour-row {
            position: relative;
            margin-bottom: 8px;
        }
        
        .hour-entry {
            position: relative;
            cursor: pointer;
            padding: 12px 16px;
            border-radius: 4px;
            background-color: #343d4e !important;
            overflow: hidden;
            user-select: none;
            transition: all 0.2s;
        }

        .hour-entry.editing {
            user-select: text;
        }

        .hour-text {
            user-select: none;
        }
        
        .hour-entry:hover {
            background-color: #373e49 !important;
        }
        
        .hour-fill.empty {
            background-color: #1f242d;
        }
        
        .hour-entry.current {
            box-shadow: 0 0 0 2px #3b82f6;
        }
        
        .hour-entry.editing {
            box-shadow: 0 0 0 2px #3108ea;
            z-index: 40;
        }
        
        .hour-entry.editing .hour-text,
        .hour-entry.editing .hour-input,
        .setting-input,
        .value-input {
            user-select: text;
            -webkit-user-select: text;
            -moz-user-select: text;
            -ms-user-select: text;
        }
        
        .hour-fill {
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            background-color: #334870;
        }
        .hour-content {
            position: relative;
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }
        
        .hour-time {
            font-size: 24px;
            width: 32px;
            user-select: none;
        }
        
        .hour-emojis {
            display: grid;
            margin: 0px;
            padding-right: 24px;
            grid-template-columns: repeat(2, 30px);
            gap: 4px;
            min-height: 30px;
            max-height: calc(30px * 3 +8);
            overflow: hidden;
            max-width: 64px;
            min-width: 64px;
        }

        .emoji {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
            height: 100%;
            font-size: 28px;
            min-height: 28px;
        }

        
        .hour-input-container {
            flex: 1;
            display: flex;
            align-items: center;
            position: relative;
        }
        
        .hour-input {
            flex: 1;
            background: transparent;
            color: #d1d5db;
            border: none;
            outline: none;
            font-size: 26px;
            padding-right: 32px;
            font-family: 'Space Mono', monospace;
            resize: none;
            overflow: hidden;
            min-height: 1.5em;
            line-height: 1.5;
            width: 100%;
        }
        
        .hour-input::placeholder {
            color: #6b7280;
        }
        
        .hour-text {
            color: #d1d5db;
            font-size: 26px;
            user-select: none;
        }
        
        .clear-btn {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: #6b7280;
            cursor: pointer;
            font-size: 16px;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s ease;
        }

        .clear-btn:hover {
            background-color: #374151;
            color: #d1d5db;
        }

        .clear-btn:hover {
            background-color: #374151;
            color: #d1d5db;
        }
        .clear-btn:hover {
            color: #ef4444;
        }
        
        .emoji-picker {
            position: absolute;
            left: 0;
            right: 0;
            background-color: #1f2937;
            padding: 12px;
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
            z-index: 50;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
        }
        
        .emoji-picker.above {
            bottom: 100%;
            margin-bottom: 8px;
        }
        
        .emoji-picker.below {
            top: 100%;
            margin-top: 8px;
        }
        
        .emoji-btn {
            padding: 8px;
            font-size: 32px;
            background: none;
            border: none;
            cursor: pointer;
            transition: background-color 0.2s;
            border-radius: 4px;
        }
        
        .emoji-btn:hover {
            background-color: #373e49;
        }
        
        .emoji-btn.selected {
            background-color: #334970;
        }
        
        .emoji-btn.selected:hover {
            background-color: #1d4ed8;
        }
        
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 30;
        }
        
        .scroll-bar {
            position: absolute;
            top: 0;
            right: 0;
            bottom: 0;
            width: 48px;
            cursor: ns-resize;
            transition: all 0.2s;
        }
        
        .scroll-bar.hidden {
            display: none;
        }
        
        .scroll-pattern {
            background: repeating-linear-gradient(
                45deg,
                transparent 0px,
                transparent 3px,
                rgba(255,255,255,0.08) 3px,
                rgba(255,255,255,0.08) 4px,
                transparent 4px,
                transparent 8px
            ),
            repeating-linear-gradient(
                -45deg,
                transparent 0px,
                transparent 3px,
                rgba(255,255,255,0.08) 3px,
                rgba(255,255,255,0.08) 4px,
                transparent 4px,
                transparent 8px
            );
        }
        
        .scroll-bar.dragging {
            background-color: rgba(255, 255, 255, 0.1);
        }
        
        .hour-indicator {
            position: absolute;
            right: 8px;
            width: 0;
            height: 0;
            border-left: 6px solid #3b82f6;
            border-top: 3px solid transparent;
            border-bottom: 3px solid transparent;
            animation: pulse 2s infinite;
            pointer-events: none;
            transform: translateY(-50%);
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .setting-group {
            margin-bottom: 24px;
        }
        
        .setting-label {
            display: block;
            color: #d1d5db;
            margin-bottom: 8px;
            font-size: 18px;
        }
        
        .setting-input {
            width: 100%;
            padding: 12px;
            background-color: #2a313e;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 18px;
            font-family: 'Space Mono', monospace;
        }
        
        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 18px;
            cursor: pointer;
        }
        
        .checkbox {
            width: 20px;
            height: 20px;
        }
        
        .goals-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        
        .add-goal-btn {
            background-color: #334970;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 1px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .add-goal-btn:hover {
            background-color: #173ca4;
        }
        
        .goal-row {
            position: relative;
            margin-bottom: 8px;
        }
        
        .goal-summary {
            cursor: pointer;
            padding: 8px 12px;
            background-color: #2a313e;
            border-radius: 1px;
            transition: background-color 0.2s;
        }
        
        .goal-summary:hover {
            background-color: #373e49;
        }
        
        .goal-summary.editing {
            box-shadow: 0 0 0 2px #eab308;
            z-index: 40;
        }
        
        .goal-summary-content {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .goal-emoji-display {
            font-size: 24px;
        }
        
        .goal-text-display {
            color: #d1d5db;
            flex: 1;
        }
        
        .remove-goal-btn {
            background: none;
            border: none;
            color: #aeb6c3;
            cursor: pointer;
            font-size: 18px;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: color 0.2s;
        }
        
        .remove-goal-btn:hover {
            color: #ef4444;
        }
        
        .goal-editor {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            margin-top: 4px;
            background-color: #1f2937;
            padding: 12px;
            z-index: 50;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
        }
        
        .goal-controls {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-top: 12px;
        }
        
        .not-btn {
            padding: 4px 12px;
            font-weight: bold;
            font-size: 14px;
            border: none;
            border-radius: 1px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .not-btn.active {
            background-color: #991b1b;
            color: #fecaca;
        }
        
        .not-btn.inactive {
            background-color: #373e49;
            color: white;
        }
        
        .operator-btn {
            background-color: #373e49;
            color: white;
            border: none;
            padding: 8px;
            border-radius: 1px;
            cursor: pointer;
            flex: 1;
            transition: background-color 0.2s;
        }
        
        .operator-btn:hover {
            background-color: #6b7280;
        }
        
        .value-input {
            background-color: #373e49;
            color: white;
            border: none;
            padding: 8px;
            border-radius: 1px;
            width: 80px;
            text-align: center;
        }
        
        .value-suffix {
            font-size: 14px;
            color: #aeb6c3;
        }
        
        .export-section {
            background-color: #2a313e;
            border-radius: 4px;
            overflow: hidden;
        }
        
        .export-toggle {
            width: 100%;
            background-color: #2a313e;
            color: white;
            border: none;
            padding: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .export-toggle:hover {
            background-color: #373e49;
        }
        
        .export-arrow {
            transition: transform 0.2s;
        }
        
        .export-arrow.open {
            transform: rotate(180deg);
        }
        
        .export-content {
            padding: 12px;
            background-color: #2a313e;
        }
        
        .export-btn {
            width: 100%;
            background-color: #334970;
            color: white;
            border: none;
            padding: 8px;
            border-radius: 4px;
            cursor: pointer;
            margin-bottom: 12px;
            transition: background-color 0.2s;
        }
        
        .export-btn:hover {
            background-color: #1d4ed8;
        }
        
        .import-section {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }
        
        .import-input {
            flex: 1;
            padding: 8px;
            background-color: #373e49;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .import-label {
            font-size: 12px;
            color: #aeb6c3;
            align-self: center;
        }
        
        .export-help {
            font-size: 12px;
            color: #aeb6c3;
            padding-top: 8px;
            border-top: 1px solid #373e49;
        }
        
        .bubbles-container {
            border-radius: 8px;
            height: 192px;
            position: relative;
            overflow: hidden;
            border: 1px solid #2a313e;
            margin-bottom: 24px;
        }
        
        .bubble {
            position: absolute;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            color: white;
        }
        
        .dailies-section h3 {
            font-size: 18px;
            font-weight: 600;
            color: white;
            margin-bottom: 12px;
        }
        
        .daily-goal {
            display: flex;
            align-items: center;
            gap: 12px;
            color: #d1d5db;
            padding: 8px 0;
        }
        
        .daily-goal-icon {
            font-size: 24px;
        }
        
        .daily-goal-text {
            font-size: 14px;
        }
        
        .no-goals-daily {
            color: #6b7280;
            font-size: 14px;
        }
        

        
        .drag-handle {
            cursor: grab;
            padding: 4px;
            color: #6b7280;
            margin-right: 8px;
        }
        .drag-handle:hover {
            color: #aeb6c3;
        }
        .drag-handle:active {
            cursor: grabbing;
        }
        
        @media (max-width: 768px) {
            .scroll-bar {
                display: none !important;
            }
            .header {
                background-color: #1f2937;
                padding: 0px 24px;
            }
            .scroll-container, .settings-container, .daily-container {
                padding: 8px 24px;
                height: 100%;
                overflow-y: auto;
            }
        }
        /* Flash effect when copying */
        @keyframes flash-border {
        0%   { box-shadow: 0 0 0 2px white; }
        100% { box-shadow: none; }
        }
        .hour-entry.flash {
        animation: flash-border 0.5s ease;
        }

    </style>
</head>
<body>
    <div id="app">
        <div class="header">
            <span style="display: flex; align-items: start; gap: 16px;">
                <h1 onclick="app.setView('timeline')"><div class="btn-active" id="floatingNavDate">hourlies</div></h1>
                <button class="btn" onclick="app.undo()" id="undoBtn" style="display: none;">‚Ü∂</button>
            </span>
        <div class="header-buttons">
                <button class="btn" onclick="app.setView('daily')">üëÅ <span class="btn-label">daily</span></button>
                <button class="btn" onclick="app.setView('settings')">‚öô <span class="btn-label">edit</span></button>
            </div>
        </div>
        <div class="main-container" id="mainContainer"></div>
    </div>

    <script>
        class HourliesApp {
            constructor() {
                this.currentTime = new Date();
                this.currentDate = new Date();
                this.startHour = 7;
                this.allEntries = {};
                this.goals = [
                    {
                        id: 1,
                        emojis: ['‚òï'],
                        isNot: false,
                        operator: 'less_than',
                        value: 3
                    },
                    {
                        id: 2,
                        emojis: ['‚òï'],
                        isNot: true,
                        operator: 'after',
                        value: 17
                    }
                ];
                this.editingHour = null;
                this.editingGoal = null;
                this.view = 'timeline';
                this.emojis = ['‚òï', 'üìñ', 'üò¥', 'üéÆ', 'üçï', 'üíä', 'üåø', 'üî¥', 'üü©', 'üî∑'];
                        this.showGoalsInTimeline = false;
                this.undoStack = [];
                this.showExportAccordion = false;
                this.clipboardEntry = null;
                this.longPressTimer = null;

                this.isDragging = false;
                this.dragSource = null;
                this.dragStartTime = null;
                this.dragThreshold = 150;
                
                this.scrollContainerRef = null;
                this.lastTapTime = 0;
                this.isScrollDragging = false;
                this.scrollDragStart = { y: 0, scrollTop: 0 };
                this.showFloatingNav = false;
                this.timelineScrollPosition = 0;

                // Load saved data from localStorage
                const saved = localStorage.getItem("hourliesData");
                if (saved) {
                    try {
                        const data = JSON.parse(saved);
                        if (data.allEntries) this.allEntries = data.allEntries;
                        if (data.goals) this.goals = data.goals;
                        if (data.emojis) this.emojis = data.emojis;
                        if (typeof data.startHour === 'number') this.startHour = data.startHour;
                        if (typeof data.showGoalsInTimeline === 'boolean') this.showGoalsInTimeline = data.showGoalsInTimeline;
                    } catch (e) {
                        console.warn("Failed to load saved data", e);
                    }
                } else {
                    // Detect if user is on mobile
                    const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
                    
                    // First time user - add welcome message to current day
                    const welcomeEntries = {
                        7: { emojis: ['üëã'], text: 'welcome to hourlies' },
                        8: { emojis: ['üìä'], text: 'track your daily activities with emojis and text' },
                        9: { emojis: [], text: '' },
                        10: { emojis: ['‚úèÔ∏è'], text: 'click any hour to add what you did' },
                        11: { emojis: [], text: '' },
                        12: { emojis: ['üìÑ'], text: isMobile ? 'long tap to copy filled hour' : 'right click to copy filled hour' },
                        13: { emojis: ['üìù'], text: 'repeat on empty hour to paste' },
                        14: { emojis: [], text: '' },
                        15: { emojis: ['‚öôÔ∏è'], text: 'go to edit to customize emojis and dailies' },
                        16: { emojis: ['üéØ'], text: 'dailies are simple rules for tracking habits' },
                        17: { emojis: [], text: '' },
                        18: { emojis: ['üè†'], text: 'daily view shows your patterns visually' },
                        19: { emojis: ['üóëÔ∏è'], text: 'wipe current day there to start fresh' }
                    };
                    this.allEntries[this.currentDateKey] = welcomeEntries;
                    
                    // Add these emojis to the available emojis list if not already present
                    const welcomeEmojis = ['üëã', 'üìä', '‚úèÔ∏è', 'üìÑ', 'üìù', '‚öôÔ∏è', 'üéØ', 'üè†', 'üóëÔ∏è'];
                    this.emojis = [...new Set([...this.emojis, ...welcomeEmojis])];
                }

                this.init();
            }

            init() {
                this.render();
                this.startTimer();
                this.setupEventListeners();
            }

            dateKey(date) {
                return date.toISOString().split('T')[0];
            }

            get currentDateKey() {
                return this.dateKey(this.currentDate);
            }

            get entries() {
                return this.allEntries[this.currentDateKey] || {};
            }

            formatHour(hour) {
                return hour.toString().padStart(2, '0');
            }

            get hours() {
                return Array.from({length: 24}, (_, i) => (this.startHour + i) % 24);
            }

            isCurrentDate() {
                return this.dateKey(this.currentTime) === this.currentDateKey;
            }

            isPastDate() {
                return new Date(this.currentDateKey) < new Date(this.dateKey(this.currentTime));
            }

            isFutureDate() {
                return new Date(this.currentDateKey) > new Date(this.dateKey(this.currentTime));
            }

            getHourFill(hour) {
                if (this.isFutureDate()) return 0;
                if (this.isPastDate()) return 100;
                if (!this.isCurrentDate()) return 0;
                
                const currentHour = this.currentTime.getHours();
                const adjustedHour = hour < this.startHour ? hour + 24 : hour;
                const adjustedCurrentHour = currentHour < this.startHour ? currentHour + 24 : currentHour;
                
                if (adjustedHour < adjustedCurrentHour) return 100;
                if (adjustedHour === adjustedCurrentHour) {
                    const minutes = this.currentTime.getMinutes();
                    return (minutes / 60) * 100;
                }
                return 0;
            }

            isCurrentHour(hour) {
                return this.isCurrentDate() && this.currentTime.getHours() === hour;
            }

            startTimer() {
                setInterval(() => {
                    const now = new Date();
                    this.currentTime = now;
                    if (this.dateKey(now) !== this.currentDateKey) {
                        this.currentDate = now;
                    }
                    this.updateTimeDisplay();
                }, 60000);
            }

            setupEventListeners() {
                document.addEventListener('mousemove', this.handleGlobalMouseMove.bind(this));
                document.addEventListener('mouseup', this.handleGlobalMouseUp.bind(this));
                document.addEventListener('click', this.handleGlobalClick.bind(this));
            }
            
            handleGlobalClick(event) {
                // Only handle clicks when in edit mode
                if (this.editingHour === null) return;
                
                // Don't handle clicks on the overlay (it has its own handler)
                if (event.target.classList.contains('overlay')) return;
                
                // Don't handle clicks inside the textarea or clear button
                if (event.target.classList.contains('hour-input') || 
                    event.target.classList.contains('clear-btn') ||
                    event.target.classList.contains('emoji-btn')) return;
                
                // Refocus the textarea and set cursor to end
                const textarea = document.querySelector(`[data-hour="${this.editingHour}"] textarea`);
                if (textarea) {
                    event.preventDefault();
                    // Wait a bit to ensure the click event is fully processed
                    setTimeout(() => {
                        textarea.focus();
                        textarea.selectionStart = textarea.selectionEnd = textarea.value.length;
                    }, 0);
                }
            }

            handleCopyPaste(hour, entry, element) {
            const hasNoContent = (!entry.text || entry.text.trim() === "") && (!entry.emojis || entry.emojis.length === 0);

            if (!hasNoContent) {
                // Only copy what exists in the source
                this.clipboardEntry = {
                    hasEmojis: entry.emojis && entry.emojis.length > 0,
                    hasText: entry.text && entry.text.trim().length > 0 && entry.text.trim() !== "",
                    emojis: entry.emojis ? [...entry.emojis] : [],
                    text: entry.text || ""
                };
                element.classList.add("flash");
                setTimeout(() => element.classList.remove("flash"), 500);
            } else if (this.clipboardEntry) {
                // Paste
                const newEntries = { ...this.entries };
                const targetHasText = entry.text && entry.text.trim() !== "";
                
                newEntries[hour] = {
                    // If clipboard has emojis, use them, otherwise keep target emojis (or empty array)
                    emojis: this.clipboardEntry.hasEmojis ? [...this.clipboardEntry.emojis] : (entry.emojis || []),
                    // If target has text, keep it, otherwise use clipboard text only if it was copied
                    text: targetHasText ? entry.text : (this.clipboardEntry.hasText ? this.clipboardEntry.text : "")
                };
                
                this.updateEntries(newEntries);
                this.renderHours();
            }
            }
            attachCopyPasteEvents() {
            const hourElements = document.querySelectorAll(".hour-entry");
            hourElements.forEach(el => {
                const hour = parseInt(el.dataset.hour);
                const entry = this.entries[hour] || { emojis: [], text: "" };

                el.addEventListener("contextmenu", (e) => {
                e.preventDefault();
                this.handleCopyPaste(hour, entry, el);
                });

                el.addEventListener("touchstart", () => {
                this.longPressTimer = setTimeout(() => {
                    this.handleCopyPaste(hour, entry, el);
                    el._suppressClick = true;
                }, 500);
                });
                el.addEventListener("touchend", () => clearTimeout(this.longPressTimer));
                el.addEventListener("touchmove", () => clearTimeout(this.longPressTimer));

                // Suppress click after long-press
                el.addEventListener("click", (e) => {
                if (el._suppressClick) {
                    e.stopImmediatePropagation();
                    el._suppressClick = false;
                }
                }, true);
            });
            }

            handleScroll(e) {
                const scrolled = e.target.scrollTop > 150;
                this.showFloatingNav = scrolled;
                
                if (this.view === 'timeline') {
                    this.timelineScrollPosition = e.target.scrollTop;
                }
                
                const floatingNavDate = document.getElementById('floatingNavDate');

                floatingNavDate.classList.add('btn-active');
                if (floatingNavDate && this.view === 'timeline') {
                    if (scrolled) {
                        floatingNavDate.textContent = this.formatNavbarDate(this.currentDate).toLowerCase();
                    } else {
                        floatingNavDate.textContent = "hourlies";
                    }
                }
            }

            handleGlobalMouseMove(e) {
                if (this.isScrollDragging && this.scrollContainerRef) {
                    const deltaY = e.clientY - this.scrollDragStart.y;
                    const newScrollTop = this.scrollDragStart.scrollTop - deltaY * 2;
                    this.scrollContainerRef.scrollTop = newScrollTop;
                }
            }

            handleGlobalMouseUp() {
                if (this.isScrollDragging) {
                    this.isScrollDragging = false;
                    this.updateScrollBar();
                }
            }

            updateEntries(newEntries) {
                this.undoStack.push({ entries: { ...this.entries }, timestamp: Date.now() });
                if (this.undoStack.length > 10) this.undoStack.shift();
                
                this.allEntries[this.currentDateKey] = newEntries;
                this.updateUndoButton();
            
                this.saveData();
            }

            wipeCurrentDayData() {
                const newEntries = {};
                this.updateEntries(newEntries);
                this.render();
            }
            shiftHoursForNewStartHour(oldStartHour, newStartHour) {
                const shiftedEntries = {};
                
                Object.entries(this.allEntries).forEach(([date, dayEntries]) => {
                    shiftedEntries[date] = {};
                    Object.entries(dayEntries).forEach(([hour, entry]) => {
                        const hourNum = parseInt(hour);
                        // Calculate how many hours this entry needs to shift
                        // If it's after the old start hour, it belongs to the same day
                        // If it's before, it belongs to the next day
                        const dayOffset = hourNum < oldStartHour ? 1 : 0;
                        const absoluteHour = hourNum + (dayOffset * 24);
                        const shiftedAbsoluteHour = absoluteHour - (oldStartHour - newStartHour);
                        const newHour = shiftedAbsoluteHour % 24;
                        
                        const targetDate = dayOffset ? 
                            new Date(date).setDate(new Date(date).getDate() + dayOffset) :
                            date;
                            
                        if (!shiftedEntries[targetDate]) {
                            shiftedEntries[targetDate] = {};
                        }
                        shiftedEntries[targetDate][newHour] = entry;
                    });
                });
                
                this.allEntries = shiftedEntries;
            }
            
            saveData() {
                const oldStartHour = JSON.parse(localStorage.getItem("hourliesData"))?.startHour;
                if (oldStartHour !== undefined && oldStartHour !== this.startHour) {
                    this.shiftHoursForNewStartHour(oldStartHour, this.startHour);
                }
                
                localStorage.setItem("hourliesData", JSON.stringify({
                    allEntries: this.allEntries,
                    goals: this.goals,
                    emojis: this.emojis,
                    startHour: this.startHour,
                    showGoalsInTimeline: this.showGoalsInTimeline
                }));            
            }
            undo() {
                if (this.undoStack.length === 0) return;
                
                const lastState = this.undoStack.pop();
                this.allEntries[this.currentDateKey] = lastState.entries;
                this.updateUndoButton();
                this.renderHours();
                this.saveData();
            }

            updateUndoButton() {
                const undoBtn = document.getElementById('undoBtn');
                if (undoBtn) {
                    undoBtn.style.display = this.view === 'timeline' && this.undoStack.length > 0 ? 'block' : 'none';
                }
            }

            setView(view) {
                // Store timeline position if leaving timeline view
                if (this.view === 'timeline' && view !== 'timeline') {
                    const container = document.querySelector('.scroll-container');
                    if (container) {
                        this.timelineScrollPosition = container.scrollTop;
                    }
                }

                this.view = view;
                this.editingHour = null;
                this.editingGoal = null;
                
                // Update active button state
                const buttons = document.querySelectorAll('.header-buttons .btn');
                buttons.forEach(btn => {
                    btn.classList.remove('btn-active');
                    if (btn.onclick.toString().includes(`'${view}'`)) {
                        btn.classList.add('btn-active');
                    }
                });

                // Update header title and classes
                const floatingNavDate = document.getElementById('floatingNavDate');
                if (floatingNavDate) {
                    if (view === 'timeline') {
                        floatingNavDate.textContent = "hourlies";
                        if (!this.showFloatingNav) {
                            floatingNavDate.classList.add('btn-active');
                        }
                    } else {
                        floatingNavDate.textContent = "‚Üê " + this.formatNavbarDate(this.currentDate).toLowerCase();
                        floatingNavDate.classList.remove('btn-active');
                    }
                }
                
                this.render();
            }

            updateTimeDisplay() {
                if (this.view === 'timeline' && this.editingHour === null) {
                    this.renderHours();
                    this.updateScrollIndicator();
                }
            }

            clearEntry(hour) {
                const newEntries = { ...this.entries };
                newEntries[hour] = { emojis: [], text: '' };
                this.updateEntries(newEntries);
                this.editingHour = null;
                this.renderHours();
            }

            editHour(hour) {
                if (this.editingHour === hour) return;
                this.editingHour = hour;
                this.renderHours();
                setTimeout(() => {
                    const hourElement = document.querySelector(`[data-hour="${hour}"]`);
                    const textarea = hourElement?.querySelector('textarea');
                    if (textarea && hourElement) {
                        // Center the hour element in view
                        hourElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        
                        textarea.focus();
                        // Move cursor to end
                        textarea.selectionStart = textarea.selectionEnd = textarea.value.length;
                        // Adjust height for content
                        textarea.style.height = '';
                        textarea.style.height = textarea.scrollHeight + 'px';
                    }
                }, 50);
            }

            toggleEmoji(emoji) {
                const entry = this.entries[this.editingHour] || { emojis: [], text: '' };
                const validEmojis = entry.emojis.filter(e => this.emojis.includes(e));
                const newEmojis = validEmojis.includes(emoji) 
                    ? validEmojis.filter(e => e !== emoji)
                    : [...validEmojis, emoji];
                
                const newEntries = { ...this.entries };
                newEntries[this.editingHour] = { ...entry, emojis: newEmojis };
                this.updateEntries(newEntries);
                this.renderHours();
                
                setTimeout(() => {
                    const textarea = document.querySelector(`[data-hour="${this.editingHour}"] textarea`);
                    if (textarea) {
                        textarea.focus();
                        // Move cursor to end
                        textarea.selectionStart = textarea.selectionEnd = textarea.value.length;
                    }
                }, 50);
            }

            updateText(text) {
                const entry = this.entries[this.editingHour] || { emojis: [], text: '' };
                const newEntries = { ...this.entries };
                newEntries[this.editingHour] = { ...entry, text };
                // Don't trigger a full render, just save
                this.undoStack.push({ entries: { ...this.entries }, timestamp: Date.now() });
                if (this.undoStack.length > 10) this.undoStack.shift();
                this.allEntries[this.currentDateKey] = newEntries;
                this.updateUndoButton();
                this.saveData();
            }

            navigateDay(direction) {
                const newDate = new Date(this.currentDate);
                newDate.setDate(newDate.getDate() + direction);
                this.currentDate = newDate;
                this.editingHour = null;
                this.render();
            }

            formatNavbarDate(date) {
                return date.toLocaleDateString('en-US', {
                    weekday: 'short',
                    month: 'short',
                    day: 'numeric'
                });
            }

            formatDateInput() {
                const d = this.currentDate.getDate().toString().padStart(2, '0');
                const m = (this.currentDate.getMonth() + 1).toString().padStart(2, '0');
                const y = this.currentDate.getFullYear().toString().slice(-2);
                return `${d}/${m}/${y}`;
            }

            handleDateFocus(event) {
                event.target.select();
            }

            handleHourInputKeydown(event, hour) {
                if (event.key === 'Enter' && !event.shiftKey) {
                    // Close edit mode only if Enter is pressed without Shift
                    event.preventDefault();
                    this.editingHour = null;
                    this.renderHours();
                } else if (event.key === 'ArrowUp' || event.key === 'ArrowDown') {
                    const textarea = event.target;
                    const atStart = textarea.selectionStart === 0;
                    const atEnd = textarea.selectionEnd === textarea.value.length;
                    const noSelection = textarea.selectionStart === textarea.selectionEnd;
                    const isMultiline = textarea.value.includes('\n');

                    // Only navigate between hours if we're at the edges of single-line content
                    if ((event.key === 'ArrowUp' && (atStart || !isMultiline)) ||
                        (event.key === 'ArrowDown' && (atEnd || !isMultiline))) {
                        event.preventDefault();
                        const currentIndex = this.hours.indexOf(hour);
                        const nextIndex = event.key === 'ArrowUp' 
                            ? (currentIndex - 1 + this.hours.length) % this.hours.length
                            : (currentIndex + 1) % this.hours.length;
                        const nextHour = this.hours[nextIndex];
                        
                        this.editHour(nextHour);
                    }
                }
            }

            handleDateKeydown(event) {
                // Allow only numbers, backspace, delete, arrow keys, tab
                if (!/^\d$/.test(event.key) && 
                    !['Backspace', 'Delete', 'ArrowLeft', 'ArrowRight', 'Tab'].includes(event.key)) {
                    event.preventDefault();
                }
            }

            handleDateInput(event) {
                let value = event.target.value.replace(/\D/g, '');
                const parts = [];
                
                // Split into day/month/year parts
                for (let i = 0; i < value.length && i < 6; i += 2) {
                    parts.push(value.slice(i, i + 2));
                }
                
                // Add slashes between parts
                event.target.value = parts.join('/');
                
                // If we have a complete date (6 digits), try to update
                if (value.length === 6) {
                    const day = parseInt(value.slice(0, 2), 10);
                    const month = parseInt(value.slice(2, 4), 10) - 1;
                    const year = 2000 + parseInt(value.slice(4, 6), 10);
                    
                    const newDate = new Date(year, month, day);
                    if (!isNaN(newDate.getTime())) {
                        this.currentDate = newDate;
                        this.render();
                    }
                }
            }

            jumpToToday() {
                this.currentDate = new Date();
                this.editingHour = null;
                this.render();
                setTimeout(() => {
                    this.scrollToCurrentHour();
                }, 100);
            }

            handleNavbarDateClick() {
                if (this.scrollContainerRef) {
                    this.scrollContainerRef.scrollTop = 0;
                }
            }

            scrollToCurrentHour() {
                if (!this.scrollContainerRef) return;
                const currentHourIndex = this.hours.findIndex(hour => hour === this.currentTime.getHours());
                if (currentHourIndex === -1) return;
                const hourElements = this.scrollContainerRef.querySelectorAll('[data-hour]');
                const targetElement = hourElements[currentHourIndex];
                if (targetElement) {
                    targetElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }

            handleScrollMouseDown(e) {
                this.isScrollDragging = true;
                this.scrollDragStart = {
                    y: e.clientY,
                    scrollTop: this.scrollContainerRef?.scrollTop || 0
                };
                e.preventDefault();
                this.updateScrollBar();
            }

            handleRightBarClick() {
                const now = Date.now();
                if (now - this.lastTapTime < 300) {
                    this.scrollToCurrentHour();
                }
                this.lastTapTime = now;
            }

            updateScrollBar() {
                const scrollBar = document.querySelector('.scroll-bar');
                if (scrollBar) {
                    if (this.isScrollDragging) {
                        scrollBar.classList.add('dragging');
                        scrollBar.classList.remove('scroll-pattern');
                    } else {
                        scrollBar.classList.remove('dragging');
                        scrollBar.classList.add('scroll-pattern');
                    }
                }
            }

            getCurrentHourPosition() {
                if (!this.scrollContainerRef) return null;
                
                const currentHourIndex = this.hours.findIndex(hour => hour === this.currentTime.getHours());
                if (currentHourIndex === -1) return null;
                
                const hourHeight = 60;
                const hourTop = currentHourIndex * hourHeight;
                const containerTop = this.scrollContainerRef.scrollTop;
                const containerHeight = this.scrollContainerRef.clientHeight;
                
                const relativePosition = (hourTop - containerTop) / containerHeight;
                
                if (relativePosition < 0 || relativePosition > 1) {
                    return Math.max(0.1, Math.min(0.9, relativePosition));
                }
                
                return null;
            }

            updateScrollIndicator() {
                const currentHourPos = this.getCurrentHourPosition();
                const indicator = document.querySelector('.hour-indicator');
                if (indicator) {
                    if (currentHourPos !== null) {
                        indicator.style.display = 'block';
                        indicator.style.top = `${currentHourPos * 100}%`;
                    } else {
                        indicator.style.display = 'none';
                    }
                }
            }

            exportCurrentDayCSV() {
                let exportContent = "";
                
                this.hours.forEach(hour => {
                    const entry = this.entries[hour];
                    const emojis = entry?.emojis?.join('') || '';
                    const text = entry?.text || '';
                    exportContent += `${emojis} ${text}"\n`;
                });
                // 02,"",""
                // 03,"‚òï","kaffee"

                
                try {
                    navigator.clipboard.writeText(exportContent);
                } catch (err) {
                    const blob = new Blob([exportContent], { type: 'text/csv' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `hourlies-${this.currentDate.toLocaleDateString('en-GB').replace(/\//g, '-')}.csv`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                }
            }

            exportAllCSV() {
                const years = Object.keys(this.allEntries)
                    .map(date => new Date(date).getFullYear())
                    .filter((v, i, a) => a.indexOf(v) === i)
                    .sort();
                
                if (years.length === 0) return;

                // Create workbook with multiple sheets
                let csvContent = "";

                // First tab: Settings and Rules
                csvContent += "# Settings\n";
                csvContent += `StartHour,${this.startHour}\n`;
                csvContent += `ShowGoalsInTimeline,${this.showGoalsInTimeline}\n`;
                csvContent += `Emojis,${this.emojis.join('')}\n\n`;
                
                csvContent += "# Dailies\n";
                csvContent += "Emojis,IsNot,Operator,Value\n";
                this.goals.forEach(goal => {
                    const goalEmojis = goal.emojis || [goal.emoji];
                    csvContent += `${goalEmojis.join('')},${goal.isNot},${goal.operator},${goal.value}\n`;
                });
                csvContent += "\n---\n\n"; // Sheet separator

                // Create a sheet for each year with data
                years.forEach(year => {
                    const yearDates = Object.keys(this.allEntries)
                        .filter(date => new Date(date).getFullYear() === year &&
                                      Object.keys(this.allEntries[date] || {}).length > 0)
                        .sort();

                    if (yearDates.length === 0) return;

                    // Group by months
                    const monthGroups = {};
                    yearDates.forEach(date => {
                        const month = new Date(date).getMonth();
                        if (!monthGroups[month]) monthGroups[month] = [];
                        monthGroups[month].push(date);
                    });

                    // Prepare year data
                    const yearData = [];

                    Object.entries(monthGroups).forEach(([month, monthDates]) => {
                        // Add month header
                        const monthName = new Date(year, parseInt(month)).toLocaleString('default', { month: 'long' });
                        yearData.push([`${monthName} ${year}`]);

                        // Add date headers row
                        const headers = ['Hour'].concat(monthDates.map(date => 
                            new Date(date).toLocaleDateString('en-GB', {
                                day: '2-digit',
                                month: '2-digit',
                                year: '2-digit'
                            })
                        ));
                        yearData.push(headers);

                        // Add hour rows
                        this.hours.forEach(hour => {
                            const row = [this.formatHour(hour)];
                            monthDates.forEach(date => {
                                const entry = this.allEntries[date]?.[hour];
                                const emojis = entry?.emojis?.join('') || '';
                                const text = entry?.text || '';
                                row.push(`${emojis}${text ? ' ' + text : ''}`);
                            });
                            yearData.push(row);
                        });

                        // Add empty row between months
                        yearData.push([]);
                    });

                    // Create year sheet
                    const yearSheet = XLSX.utils.aoa_to_sheet(yearData);
                    XLSX.utils.book_append_sheet(workbook, yearSheet, year.toString());
                });

                // Write workbook and trigger download
                const wbout = XLSX.write(workbook, { bookType: 'xlsx', type: 'binary' });
                
                function s2ab(s) {
                    const buf = new ArrayBuffer(s.length);
                    const view = new Uint8Array(buf);
                    for (let i = 0; i < s.length; i++) view[i] = s.charCodeAt(i) & 0xFF;
                    return buf;
                }

                const blob = new Blob([s2ab(wbout)], { type: 'application/octet-stream' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'hourlies.xlsx';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                document.head.removeChild(script);
            }

            importCSV(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const csv = e.target.result;
                        const lines = csv.split('\n').filter(line => line.trim());
                        const headers = lines[0].split(',');
                        
                        if (headers.includes('Date')) {
                            const newEntries = {};
                            
                            lines.slice(1).forEach(line => {
                                const [date, hour, emojis, text] = line.split(',').map(cell => 
                                    cell.replace(/^"/, '').replace(/"$/, '')
                                );
                                
                                if (date && hour) {
                                    const isoDate = new Date(date.split('/').reverse().join('-')).toISOString().split('T')[0];
                                    if (!newEntries[isoDate]) newEntries[isoDate] = {};
                                    
                                    newEntries[isoDate][parseInt(hour)] = {
                                        emojis: emojis ? [...emojis] : [],
                                        text: text || ''
                                    };
                                }
                            });
                            
                            this.allEntries = { ...this.allEntries, ...newEntries };
                        } else {
                            const dayEntries = {};
                            
                            lines.slice(1).forEach(line => {
                                const [hour, emojis, text] = line.split(',').map(cell => 
                                    cell.replace(/^"/, '').replace(/"$/, '')
                                );
                                
                                if (hour) {
                                    dayEntries[parseInt(hour)] = {
                                        emojis: emojis ? [...emojis] : [],
                                        text: text || ''
                                    };
                                }
                            });
                            
                            this.allEntries[this.currentDateKey] = dayEntries;
                        }
                        
                        alert('CSV imported successfully!');
                        this.render();
                    } catch (error) {
                        alert('Invalid CSV file: ' + error.message);
                    }
                };
                reader.readAsText(file);
                event.target.value = '';
            }

            addGoal() {
                const newGoal = {
                    id: Date.now(),
                    emojis: ['üìñ'],
                    isNot: false,
                    operator: 'more_than',
                    value: 1
                };
                this.goals.push(newGoal);
                this.renderSettings();
            }

            updateGoal(id, updates) {
                this.goals = this.goals.map(goal => goal.id === id ? { ...goal, ...updates } : goal);
                this.renderSettings();
            }

            removeGoal(id) {
                this.goals = this.goals.filter(goal => goal.id !== id);
                this.renderSettings();
            }

            editGoal(id) {
                this.editingGoal = this.editingGoal === id ? null : id;
                this.renderSettings();
                if (this.editingGoal !== null) {
                    setTimeout(() => {
                        const input = document.querySelector(`.goal-value[data-goal="${id}"]`);
                        if (input) {
                            input.focus();
                            input.selectionStart = input.selectionEnd = input.value.length;
                        }
                    }, 50);
                }
            }

            handleGoalInputKeydown(event, goalId) {
                if (event.key === 'Enter') {
                    this.editingGoal = null;
                    this.renderSettings();
                } else if (event.key === 'ArrowUp' || event.key === 'ArrowDown') {
                    event.preventDefault();
                    const currentGoal = this.goals.find(g => g.id === goalId);
                    const currentIndex = this.goals.indexOf(currentGoal);
                    const nextIndex = event.key === 'ArrowUp'
                        ? (currentIndex - 1 + this.goals.length) % this.goals.length
                        : (currentIndex + 1) % this.goals.length;
                    this.editGoal(this.goals[nextIndex].id);
                }
            }

            toggleGoalEmoji(goalId, emoji) {
                const goal = this.goals.find(g => g.id === goalId);
                const currentEmojis = (goal.emojis || [goal.emoji]).filter(e => this.emojis.includes(e));
                const newEmojis = currentEmojis.includes(emoji)
                    ? currentEmojis.filter(e => e !== emoji)
                    : [...currentEmojis, emoji];
                
                this.updateGoal(goalId, { emojis: newEmojis });
            }

            cycleOperator(goalId) {
                const goal = this.goals.find(g => g.id === goalId);
                const operators = ['more_than', 'less_than', 'before', 'after'];
                const currentIndex = operators.indexOf(goal.operator);
                const nextIndex = (currentIndex + 1) % operators.length;
                this.updateGoal(goalId, { operator: operators[nextIndex] });
            }

            formatGoalText(goal) {
                const notText = goal.isNot ? 'not ' : '';
                const opText = goal.operator.replace('_', ' ');
                const suffix = goal.operator.includes('than') ? ' times' : '';
                return `${notText}${opText} ${goal.value}${suffix}`;
            }

            checkGoals() {
                const dayEntries = Object.values(this.entries);
                return this.goals.map(goal => {
                    const goalEmojis = (goal.emojis || [goal.emoji]).filter(emoji => this.emojis.includes(emoji));
                    
                    const emojiCount = dayEntries.reduce((count, entry) => {
                        return count + goalEmojis.reduce((emojiSum, emoji) => {
                            return emojiSum + (entry.emojis?.filter(e => e === emoji).length || 0);
                        }, 0);
                    }, 0);
                    
                    const emojiHours = Object.keys(this.entries).filter(hour => 
                        this.entries[hour].emojis?.some(emoji => goalEmojis.includes(emoji))
                    ).map(Number);
                    
                    let met = false;
                    let applicable = true;
                    
                    if (goal.operator === 'more_than') {
                        met = goal.isNot ? emojiCount <= goal.value : emojiCount > goal.value;
                    } else if (goal.operator === 'less_than') {
                        met = goal.isNot ? emojiCount >= goal.value : emojiCount < goal.value;
                    } else if (goal.operator === 'before') {
                        applicable = emojiHours.length > 0;
                        const condition = applicable && ((Math.min(...emojiHours)-this.startHour)+24%24) < ((goal.value - this.startHour)+24)%24;
                        met = goal.isNot ? !condition : condition;
                    } else if (goal.operator === 'after') {
                        applicable = emojiHours.length > 0;
                        const condition = applicable && ((Math.max(...emojiHours)-this.startHour)+24)%24 > ((goal.value - this.startHour)+24)%24;
                        met = goal.isNot ? !condition : condition;
                    }
                    
                    return { ...goal, met, applicable, emojis: goalEmojis };
                });
            }

            getDayEmojis() {
                const emojiCounts = {};
                Object.values(this.entries).forEach(entry => {
                    if (entry.emojis) {
                        entry.emojis.forEach(emoji => {
                            emojiCounts[emoji] = (emojiCounts[emoji] || 0) + 1;
                        });
                    }
                });
                return emojiCounts;
            }

            shouldShowAbove(hourIndex) {
                return hourIndex >= this.hours.length - 3;
            }

            render() {
                this.updateUndoButton();
                
                if (this.view === 'timeline') {
                    this.renderTimeline();
                } else if (this.view === 'settings') {
                    this.renderSettings();
                } else if (this.view === 'daily') {
                    this.renderDaily();
                }
            }

            renderTimeline() {
                const container = document.getElementById('mainContainer');
                container.innerHTML = `
                    <div class="scroll-container">
                        <div class="date-nav">
                            <div class="date-nav-left">
                                <button class="date-btn secondary-btn" onclick="app.navigateDay(-1)">‚Üê</button>
                                <input type="text" 
                                    class="date-input secondary-btn large"
                                    value="${this.formatDateInput()}"
                                    maxlength="8"
                                    inputmode="numeric"
                                    pattern="[0-9]*"
                                    onkeydown="app.handleDateKeydown(event)"
                                    oninput="app.handleDateInput(event)"
                                    onfocus="app.handleDateFocus(event)"
                                    onclick="app.handleDateFocus(event)">
                                <button class="date-btn secondary-btn" onclick="app.navigateDay(1)">‚Üí</button>
                            </div>
                            <div class="date-nav-right">
                                <button class="jump-btn secondary-btn" onclick="app.jumpToToday()">now</button>
                                <button class="btn normal-size" onclick="app.exportCurrentDayCSV()">üìã</button>
                            </div>
                        </div>
                        
                        <div id="goalsSection"></div>
                        <div id="hoursContainer"></div>
                    </div>
                    
                    <div class="scroll-bar ${this.editingHour !== null ? 'hidden' : ''} scroll-pattern"
                         onmousedown="app.handleScrollMouseDown(event)"
                         onclick="app.handleRightBarClick()">
                        <div class="hour-indicator" style="display: none;"></div>
                    </div>
                `;

                this.scrollContainerRef = container.querySelector('.scroll-container');
                this.scrollContainerRef.addEventListener('scroll', this.handleScroll.bind(this));

                if (this.timelineScrollPosition > 0) {
                    this.scrollContainerRef.scrollTop = this.timelineScrollPosition;
                }

                this.renderGoals();
                this.renderHours();
                this.updateScrollIndicator();
            }

            renderGoals() {
                const goalsSection = document.getElementById('goalsSection');
                const goalChecks = this.checkGoals();

                if (this.goals.length > 0 && this.showGoalsInTimeline) {
                    goalsSection.innerHTML = `
                        <div class="goals-section">
                            <h2 class="goals-title">dailies</h2>
                            ${goalChecks.map(goal => {
                                const itemClass = goal.met ? 'passed' : (goal.applicable && !goal.met) ? 'failed' : '';
                                return `
                                    <div class="goal-item ${itemClass}">
                                        <span class="goal-emoji-display">${(goal.emojis || []).sort((a, b) => this.emojis.indexOf(a) - this.emojis.indexOf(b)).join('')}</span>
                                        <span class="goal-text">${this.formatGoalText(goal)}</span>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    `;
                } else if (this.goals.length === 0 && this.showGoalsInTimeline) {
                    goalsSection.innerHTML = `
                        <div class="no-goals">
                            no dailies set - add in settings
                        </div>
                    `;
                } else {
                    goalsSection.innerHTML = '';
                }
            }

            renderHours() {
                this.saveData();
                const hoursContainer = document.getElementById('hoursContainer');
                hoursContainer.innerHTML = `
                    <div class="hours-container">
                        ${this.hours.map((hour, hourIndex) => {
                            const entry = this.entries[hour] || { emojis: [], text: '' };
                            const isCurrent = this.isCurrentHour(hour);
                            const isEditing = this.editingHour === hour;
                            const hourFill = this.getHourFill(hour);
                            const showAbove = this.shouldShowAbove(hourIndex);
                            // Sort emojis according to their order in this.emojis and take first 9
                            const emojis = (entry.emojis || [])
                                .sort((a, b) => this.emojis.indexOf(a) - this.emojis.indexOf(b))
                                .slice(0, 9);
                            return `
                                <div class="hour-row">
                                    ${isEditing && showAbove ? `
                                        <div class="emoji-picker above">
                                            ${this.emojis.map(emoji => `
                                                <button class="emoji-btn ${entry.emojis?.includes(emoji) ? 'selected' : ''}"
                                                        onclick="app.toggleEmoji('${emoji}')">
                                                    ${emoji}
                                                </button>
                                            `).join('')}
                                        </div>
                                    ` : ''}
                                    <div class="hour-entry ${isCurrent ? 'current' : ''} ${isEditing ? 'editing' : ''} ${hourFill === 100 && !entry.text.trim() && (!entry.emojis || entry.emojis.length === 0) ? 'empty-past' : ''}"
                                         data-hour="${hour}"
                                         onclick="this.scrollIntoView({behavior: 'smooth', block: 'center'}); app.editHour(${hour})">
                                        ${hourFill > 0 ? `
                                            <div class="hour-fill ${!entry.text && (!entry.emojis || entry.emojis.length === 0) ? 'empty' : ''}" style="width: ${hourFill}%;"></div>
                                        ` : ''}
                                        <div class="hour-content">
                                            <span class="hour-time">${this.formatHour(hour)}</span>
                                            <div class="hour-emojis">
                                                ${emojis.map(emoji => `
                                                    <span class="emoji">${emoji}</span>
                                                `).join('')}
                                            </div>
                                            ${isEditing ? `
                                                <div class="hour-input-container"
                                                     onkeydown="app.handleHourInputKeydown(event, ${hour})">
                                                    <textarea 
                                                           class="hour-input"
                                                           placeholder="${this.isFutureDate() ? 'Plan ahead...' : 
                                                                       this.isPastDate() ? 'Remember what happened...' : 
                                                                       'What is happening?'}"
                                                           oninput="app.updateText(this.value); this.style.height = ''; this.style.height = this.scrollHeight + 'px'"
                                                           onclick="event.stopPropagation()"
                                                           rows="1">${entry.text}</textarea>
                                                    <button class="clear-btn" 
                                                            onclick="event.stopPropagation(); app.clearEntry(${hour})">√ó</button>
                                                </div>
                                            ` : `
                                                <span class="hour-text">${entry.text}</span>
                                            `}
                                        </div>
                                    </div>
                                    ${isEditing && !showAbove ? `
                                        <div class="emoji-picker below">
                                            ${this.emojis.map(emoji => `
                                                <button class="emoji-btn ${entry.emojis?.includes(emoji) ? 'selected' : ''}"
                                                        onclick="app.toggleEmoji('${emoji}')">
                                                    ${emoji}
                                                </button>
                                            `).join('')}
                                        </div>
                                    ` : ''}
                                </div>
                            `;
                        }).join('')}
                        ${this.editingHour !== null ? `
                            <div class="overlay" onclick="app.editingHour = null; app.renderHours()"></div>
                        ` : ''}
                    </div>
                `;
                this.attachCopyPasteEvents();
                this.renderGoalsList();
                this.renderGoals();
            }

            renderSettings() {
                const container = document.getElementById('mainContainer');
                container.innerHTML = `
                    <div class="settings-container">
                       
                        
                        <div class="setting-group">
                            <label class="setting-label">Available Emojis</label>
                            <input type="text" 
                                   class="setting-input"
                                   value="${this.emojis.join('')}"
                                   oninput="app.emojis = [...this.value]; app.render()">
                        </div>
                        
                        <div class="setting-group">
                            <div class="goals-header">
                                <label class="setting-label">Dailies</label>
                            </div>
                            <div id="goalsList"></div>
                        </div>

                        <div class="setting-group" style="display: flex; justify-content: space-between; align-items: center;">
                            <button class="add-goal-btn" onclick="app.addGoal()">+ Add Daily</button>
                            <label class="checkbox-label" style="margin-bottom: 0;">
                                <input type="checkbox" 
                                       class="checkbox"
                                       ${this.showGoalsInTimeline ? 'checked' : ''}
                                       onchange="app.showGoalsInTimeline = this.checked; app.render()">
                                <span>Show goals in timeline view</span>
                            </label>
                            
                        </div>

                         <div class="setting-group">
                            <label class="setting-label">Start Hour</label>
                            <select class="setting-input" onchange="app.startHour = parseInt(this.value); app.render()">
                                ${Array.from({length: 24}, (_, i) => `
                                    <option value="${i}" ${i === this.startHour ? 'selected' : ''}>
                                        ${this.formatHour(i)}:00
                                    </option>
                                `).join('')}
                            </select>
                        </div>

                        <div class="setting-group">
                            <div class="export-section">
                                <button class="export-toggle" onclick="app.showExportAccordion = !app.showExportAccordion; app.renderSettings()">
                                    <label class="setting-label">Data Export/Import</label>

                                    <span class="export-arrow ${this.showExportAccordion ? 'open' : ''}">‚ñº</span>
                                </button>
                                
                                ${this.showExportAccordion ? `
                                    <div class="export-content">
                                        <button class="export-btn" onclick="app.exportAllCSV()">
                                            Export All Data (CSV)
                                        </button>
                                        
                                        <div class="import-section">
                                            <input type="file" 
                                                   class="import-input"
                                                   accept=".csv"
                                                   onchange="app.importCSV(event)">
                                            <span class="import-label">Import CSV</span>
                                        </div>
                                        
                                        <div class="export-help">
                                            CSV export includes all dates, goals, and settings. 
                                            Current day export copies to clipboard.
                                        </div>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                        
                        ${this.editingGoal !== null ? `
                            <div class="overlay" onclick="app.editingGoal = null; app.renderSettings()"></div>
                        ` : ''}
                    </div>

                        </div>
                `;

                this.renderGoalsList();
            }

            renderGoalsList() {
                const goalsList = document.getElementById('goalsList');
                if (!goalsList) return;

                // Sort goals based on their emojis' order in the config
                const sortedGoals = [...this.goals].sort((a, b) => {
                    const aEmojis = a.emojis || [a.emoji];
                    const bEmojis = b.emojis || [b.emoji];
                    const aFirstEmoji = aEmojis[0];
                    const bFirstEmoji = bEmojis[0];
                    return this.emojis.indexOf(aFirstEmoji) - this.emojis.indexOf(bFirstEmoji);
                });
                
                goalsList.innerHTML = sortedGoals.map(goal => {
                    const goalEmojis = (goal.emojis || [goal.emoji])
                        .filter(e => this.emojis.includes(e))
                        .sort((a, b) => this.emojis.indexOf(a) - this.emojis.indexOf(b));
                    const isEditing = this.editingGoal === goal.id;
                    
                    return `
                        <div class="goal-row ${isEditing ? 'editing' : ''}">
                            <div class="goal-emojis">
                                ${this.emojis.map(emoji => `
                                    <button class="emoji-btn ${goalEmojis.includes(emoji) ? 'selected' : ''}"
                                            onclick="app.toggleGoalEmoji(${goal.id}, '${emoji}')">
                                        ${emoji}
                                    </button>
                                `).join('')}
                            </div>
                            <div class="goal-controls">
                                <button class="goal-toggle ${goal.isNot ? 'active' : ''}"
                                        onclick="app.updateGoal(${goal.id}, {isNot: !${goal.isNot}})">
                                    ${goal.isNot ? 'is not' : 'is'}
                                </button>
                                <button class="goal-operator"
                                        onclick="app.cycleOperator(${goal.id})">
                                    ${goal.operator.replace('_', ' ')}
                                </button>
                                <input type="number" 
                                       class="goal-value" 
                                       data-goal="${goal.id}"
                                       value="${goal.value}"
                                       onkeydown="app.handleGoalInputKeydown(event, ${goal.id})"
                                       onchange="app.updateGoal(${goal.id}, {value: parseInt(this.value) || 0})"
                                       min="0"
                                       ${isEditing ? 'focused' : ''}>
                                <button class="remove-goal" 
                                        onclick="app.removeGoal(${goal.id})">√ó</button>
                            </div>
                        </div>
                    `;
                }).join('');

                goalsList.innerHTML = sortedGoals.map(goal => {
                    const goalEmojis = (goal.emojis || [goal.emoji])
                        .filter(e => this.emojis.includes(e))
                        .sort((a, b) => this.emojis.indexOf(a) - this.emojis.indexOf(b));
                    const isEditing = this.editingGoal === goal.id;

                    return `
                        <div class="goal-row">
                            <div class="goal-summary ${isEditing ? 'editing' : ''}"
                                 onclick="app.editGoal(${goal.id})">
                                <div class="goal-summary-content">
                                    <span class="goal-emoji-display">${goalEmojis.join('')}</span>
                                    <span class="goal-text-display">${this.formatGoalText(goal)}</span>
                                    <button class="remove-goal-btn" 
                                            onclick="event.stopPropagation(); app.removeGoal(${goal.id})">√ó</button>
                                </div>
                            </div>
                            
                            ${isEditing ? `
                                <div class="goal-editor" style="z-index: 60;">
                                    <div class="emoji-picker">
                                        ${this.emojis.map(emoji => `
                                            <button class="emoji-btn ${goalEmojis.includes(emoji) ? 'selected' : ''}"
                                                    onclick="app.toggleGoalEmoji(${goal.id}, '${emoji}')">
                                                ${emoji}
                                            </button>
                                        `).join('')}
                                    </div>
                                    <div class="goal-controls">
                                        <button class="not-btn ${goal.isNot ? 'active' : 'inactive'}"
                                                onclick="app.updateGoal(${goal.id}, { isNot: ${!goal.isNot} })">
                                            ${goal.isNot ? 'NOT' : 'IS'}
                                        </button>
                                        <button class="operator-btn" onclick="app.cycleOperator(${goal.id})">
                                            ${goal.operator.replace('_', ' ')}
                                        </button>
                                        <input type="number" 
                                               class="value-input"
                                               value="${goal.value}"
                                               min="0" max="23"
                                               oninput="app.updateGoal(${goal.id}, { value: parseInt(this.value) })">
                                        <span class="value-suffix">
                                            ${goal.operator.includes('than') ? 'times' : ''}
                                        </span>
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    `;
                }).join('');
            }

            renderDaily() {
                const container = document.getElementById('mainContainer');
                const dayEmojis = this.getDayEmojis();
                const goalChecks = this.checkGoals();
                
                container.innerHTML = `
                    <div class="daily-container">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 16px;">
                            <button class="btn normal-size jump-btn" onclick="if(confirm('Are you sure you want to clear all data for this day?')) { app.wipeCurrentDayData(); }">üóëÔ∏è wipe</button>
                            <button class="btn normal-size jump-btn" onclick="app.exportCurrentDayCSV()">copy üìã</button>
                        </div>
                        <div class="bubbles-container">
                            ${Object.entries(dayEmojis).map(([emoji, count], index) => {
                                const maxCount = Math.max(...Object.values(dayEmojis), 1);
                                const size = 30 + (count / maxCount) * 40;
                                const x = (index * 80 + 50) % 300;
                                const y = 30 + (index * 50) % 120;
                                return `
                                    <div class="bubble" style="
                                        left: ${x}px; 
                                        top: ${y}px; 
                                        width: ${size}px; 
                                        height: ${size}px; 
                                        font-size: ${size * 0.5}px
                                    ">
                                        ${emoji}
                                    </div>
                                `;
                            }).join('')}
                        </div>
                        
                    <div class="dailies-section">
                    <h3>Dailies</h3>
                    ${goalChecks.map(goal => {
                        const itemClass = goal.met ? 'passed' : (goal.applicable && !goal.met) ? 'failed' : '';
                        return `
                            <div class="goal-item ${itemClass}" style="font-size:18px; font-weight:500; margin-bottom:8px;">
                            <span class="goal-emoji-display">${(goal.emojis || []).sort((a, b) => this.emojis.indexOf(a) - this.emojis.indexOf(b)).join('')}</span>
                            <span class="goal-text">${this.formatGoalText(goal)}</span>
                            </div>
                        `;
                    }).join('')}
                    ${this.goals.length === 0 ? `<p class="no-goals-daily">No dailies set</p>` : ''}
                    </div>

                    </div>
                `;
            }


        }

        const app = new HourliesApp();
    </script>
    
</body>
</html>
